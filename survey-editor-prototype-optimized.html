<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Editor - Notion-Inspired Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Survey Builder Data Function - Define before Alpine.js loads
        window.surveyBuilderData = function() {
            return {
                selectedQuestion: null,
                showSettings: false,
                showQuestionTypes: null,
                // Question type categories - 30+ types organized intuitively
                questionTypeCategories: {
                    essentials: [
                        { id: 'text_input', name: 'Text Input', icon: '💬' },
                        { id: 'long_text', name: 'Long Text', icon: '📝' },
                        { id: 'multiple_choice', name: 'Multiple Choice', icon: '🔘' },
                        { id: 'checkbox', name: 'Checkboxes', icon: '☑️' },
                        { id: 'dropdown', name: 'Dropdown', icon: '▼' },
                        { id: 'yes_no', name: 'Yes/No', icon: '👍' }
                    ],
                    rating: [
                        { id: 'star_rating', name: 'Star Rating', icon: '⭐' },
                        { id: 'number_scale', name: 'Number Scale', icon: '🔢' },
                        { id: 'nps', name: 'Nps', icon: '🎯' },
                        { id: 'likert', name: 'Likert Scale', icon: '📊' },
                        { id: 'slider', name: 'Slider', icon: '🎚️' },
                        { id: 'emoji_scale', name: 'Emoji Scale', icon: '😊' }
                    ],
                    input: [
                        { id: 'number', name: 'Number', icon: '💯' },
                        { id: 'email', name: 'Email', icon: '✉️' },
                        { id: 'phone', name: 'Phone', icon: '📱' },
                        { id: 'url', name: 'Website', icon: '🌐' },
                        { id: 'date', name: 'Date', icon: '📅' },
                        { id: 'time', name: 'Time', icon: '🕐' }
                    ],
                    advanced: [
                        { id: 'matrix', name: 'Matrix Table', icon: '⊞' },
                        { id: 'ranking', name: 'Rank Order', icon: '📋' },
                        { id: 'constant_sum', name: 'Constant Sum', icon: '💯' },
                        { id: 'max_diff', name: 'MaxDiff', icon: '⚖️' },
                        { id: 'side_by_side', name: 'Side by Side', icon: '📊' },
                        { id: 'card_sort', name: 'Card Sort', icon: '🗂️' }
                    ],
                    media: [
                        { id: 'file_upload', name: 'File Upload', icon: '📎' },
                        { id: 'image_choice', name: 'Image Choice', icon: '🖼️' },
                        { id: 'signature', name: 'Signature', icon: '✍️' },
                        { id: 'drawing', name: 'Drawing', icon: '🎨' },
                        { id: 'video_response', name: 'Video', icon: '📹' },
                        { id: 'audio_response', name: 'Audio', icon: '🎤' }
                    ],
                    interactive: [
                        { id: 'heat_map', name: 'Heat Map', icon: '🔥' },
                        { id: 'hot_spot', name: 'Hot Spot', icon: '🎯' },
                        { id: 'map_location', name: 'Map Location', icon: '📍' },
                        { id: 'priority_grid', name: 'Priority Grid', icon: '⊞' }
                    ]
                },
                
                debouncedAutosave() {
                    // Placeholder for auto-save functionality
                    console.log('Auto-saving...');
                },
                
                validateQuestionNumber(questionId) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (!question) return;
                    
                    // Check for duplicates
                    const duplicates = this.questions.filter(q => 
                        q.id !== questionId && 
                        q.questionNumber && 
                        q.questionNumber.trim().toLowerCase() === question.questionNumber.trim().toLowerCase()
                    );
                    
                    // Store validation result for this question
                    if (!this.questionNumberValidation) {
                        this.questionNumberValidation = {};
                    }
                    
                    this.questionNumberValidation[questionId] = {
                        isValid: duplicates.length === 0,
                        duplicateWith: duplicates.length > 0 ? duplicates[0].id : null
                    };
                },
                
                isQuestionNumberValid(questionId) {
                    if (!this.questionNumberValidation || !this.questionNumberValidation[questionId]) {
                        return true; // Default to valid if not yet validated
                    }
                    return this.questionNumberValidation[questionId].isValid;
                },
                
                getDuplicateQuestionText(questionId) {
                    if (!this.questionNumberValidation || !this.questionNumberValidation[questionId]) {
                        return '';
                    }
                    
                    const duplicateId = this.questionNumberValidation[questionId].duplicateWith;
                    if (!duplicateId) return '';
                    
                    const duplicateQuestion = this.questions.find(q => q.id === duplicateId);
                    if (!duplicateQuestion) return '';
                    
                    // Return a truncated version of the duplicate question's text
                    const text = duplicateQuestion.text || 'Untitled question';
                    return text.length > 30 ? text.substring(0, 30) + '...' : text;
                }
            }
        }
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        /* Consolidated and optimized CSS */
        :root {
            --border-gray: rgb(229 231 235);
            --focus-ring: rgb(99 102 241);
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;
        }
        
        /* Form Input Styles - Consolidated */
        input:where(:not([type='checkbox']):not([type='radio']):not([type='file'])),
        textarea,
        select {
            border-color: var(--border-gray) !important;
        }
        
        .settings-panel :is(input[type='text'], input[type='number'], input[type='email'], 
                           input[type='password'], input[type='search'], input[type='tel'], 
                           input[type='url'], textarea, select):focus {
            border-color: transparent !important;
            outline: none !important;
            box-shadow: 0 0 0 2px var(--focus-ring) !important;
        }
        
        /* Common transitions */
        .transition-common {
            transition: all var(--transition-fast);
        }
        
        /* Block interactions */
        .block-handle,
        .block-actions {
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .block:hover .block-handle,
        .block:hover .block-actions {
            opacity: 1;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        @keyframes diffPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .slash-menu,
        .question-type-dropdown {
            animation: slideUp var(--transition-fast) ease-out;
        }
        
        .block {
            animation: fadeIn var(--transition-normal) ease-out;
        }
        
        /* Tab styles */
        .tab {
            position: relative;
        }
        
        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #6366f1;
            transform: scaleX(0);
            transition: transform var(--transition-normal) ease;
        }
        
        .tab.active::after {
            transform: scaleX(1);
        }
        
        /* Utility classes */
        .kbd {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 14px;
            font-family: monospace;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Device Frame */
        .device-frame {
            position: relative;
            transform: scale(0.7);
            transform-origin: top center;
        }
        
        .device-frame::before,
        .device-frame::after {
            content: '';
            position: absolute;
            background: #1a1a1a;
        }
        
        .device-frame::before {
            top: 50%;
            left: -15px;
            width: 3px;
            height: 60px;
            border-radius: 2px 0 0 2px;
            transform: translateY(-50%);
        }
        
        .device-frame::after {
            top: 20%;
            right: -15px;
            width: 3px;
            height: 40px;
            border-radius: 0 2px 2px 0;
        }
        
        /* AI Chat Widget */
        .ai-chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }
        
        .ai-chat-button {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal) ease;
        }
        
        .ai-chat-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .ai-chat-window {
            position: absolute;
            bottom: 72px;
            right: 0;
            width: 380px;
            height: 600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Collaboration */
        .collab-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e5e7eb;
            border: 2px solid white;
            margin-left: -8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
        }
        
        .collab-avatar:first-child {
            margin-left: 0;
        }
        
        .activity-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            margin-left: 6px;
            animation: pulse 2s infinite;
        }
        
        /* Version History */
        .version-badge {
            background: #f3f4f6;
            color: #6b7280;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            margin-left: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .version-badge:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        /* Question Options */
        .question-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .question-option:hover {
            background: #f3f4f6;
        }
        
        .option-drag-handle {
            color: #9ca3af;
            cursor: move;
            padding: 4px;
        }
        
        .option-drag-handle:hover {
            color: #6b7280;
        }
        
        .option-remove {
            opacity: 0;
            transition: opacity 0.2s;
            padding: 4px;
            color: #6b7280;
            border-radius: 4px;
        }
        
        .question-option:hover .option-remove {
            opacity: 1;
        }
        
        .option-remove:hover {
            background: #f3f4f6;
            color: #ef4444;
        }
        
        .add-option-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            color: #6366f1;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .add-option-button:hover {
            background: #eef2ff;
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 380px;
            height: 100vh;
            background: white;
            border-left: 1px solid #e5e7eb;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.08);
            transform: translateX(100%);
            transition: transform var(--transition-normal) ease-out;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        
        .settings-panel.show {
            transform: translateX(0);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #e5e7eb;
            transition: var(--transition-fast);
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition-fast);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input:checked + .toggle-slider {
            background-color: #6366f1;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Small toggle */
        .toggle-switch-sm {
            width: 36px;
            height: 20px;
        }
        
        .toggle-switch-sm .toggle-slider:before {
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
        }
        
        .toggle-switch-sm input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }
        
        /* Comment System */
        .comment-indicator {
            position: absolute;
            right: -40px;
            top: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .block:hover .comment-indicator,
        .comment-indicator.has-comments {
            opacity: 1;
        }
        
        .comment-bubble {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .comment-bubble:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }
        
        .comment-bubble.has-comments {
            background: #fef3c7;
            border: 1px solid #fbbf24;
        }
        
        .comment-bubble.has-unresolved {
            background: #fee2e2;
            border: 1px solid #ef4444;
        }
        
        /* Question Type Dropdown */
        .question-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            width: 260px;
            max-height: 380px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            z-index: 50;
        }
        
        .question-type-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            width: 100%;
            text-align: left;
            background: white;
            position: relative;
        }
        
        .question-type-item:hover {
            background-color: #f9fafb;
        }
        
        .question-type-item.highlighted {
            background-color: #eef2ff;
        }
        
        .question-type-item:hover::before,
        .question-type-item.highlighted::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: #6366f1;
        }
        
        /* Diff Styles */
        .diff-inline {
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .diff-added {
            background: #d1fae5;
            color: #065f46;
            text-decoration: none;
        }
        
        .diff-removed {
            background: #fee2e2;
            color: #991b1b;
            text-decoration: line-through;
        }
        
        .diff-highlight-added {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
            animation: diffPulse 2s ease-in-out;
        }
        
        .diff-highlight-modified {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            animation: diffPulse 2s ease-in-out;
        }
        
        .diff-highlight-removed {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            opacity: 0.6;
            position: relative;
        }
        
        .diff-highlight-removed::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #ef4444;
        }
        
        /* Change items */
        .change-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .change-added {
            background: #d1fae5;
            color: #065f46;
        }
        
        .change-modified {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .change-removed {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="surveyEditor()" @keydown.window.ctrl.h="versionPanelOpen = true">
    
    <!-- Header with breadcrumb and status dropdown -->
    <header class="bg-white border-b border-gray-200 px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="#" class="text-gray-500 hover:text-gray-700">← Surveys</a>
                <span class="text-gray-400">/</span>
                <h1 class="text-xl font-medium text-gray-900">Customer Satisfaction Survey 2024</h1>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Collaboration Avatars -->
                <div class="flex items-center">
                    <template x-for="(user, idx) in [
                        {initials: 'GP', color: 'bg-indigo-500', name: 'You'},
                        {initials: 'SC', color: 'bg-purple-500', name: 'Sarah Chen'},
                        {initials: 'MJ', color: 'bg-green-500', name: 'Mike Johnson'}
                    ]" :key="idx">
                        <div class="collab-avatar" :class="user.color + ' text-white text-xs'" :title="user.name" x-text="user.initials"></div>
                    </template>
                    <div class="collab-avatar text-xs" title="2 more team members">+2</div>
                    <div class="activity-dot" title="Active now"></div>
                </div>
                
                <!-- Version Badge -->
                <div class="version-badge" @click="versionPanelOpen = true" title="View version history">
                    <span>v3</span>
                    <span class="text-xs opacity-70 ml-1">(2 hours ago)</span>
                </div>
                
                <!-- Status Dropdown -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="flex items-center space-x-1.5 px-2.5 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                        <span class="text-sm font-medium" x-text="status.charAt(0).toUpperCase() + status.slice(1)"></span>
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg border border-gray-200 py-1 z-50">
                        <template x-for="statusOption in ['draft', 'published', 'archived']" :key="statusOption">
                            <button @click="status = statusOption; open = false" 
                                    class="w-full text-left px-4 py-2 text-base hover:bg-gray-100 flex items-center">
                                <span x-show="status === statusOption" class="mr-2">✓</span>
                                <span x-show="status !== statusOption" class="mr-2 opacity-0">✓</span>
                                <span x-text="statusOption.charAt(0).toUpperCase() + statusOption.slice(1)"></span>
                            </button>
                        </template>
                    </div>
                </div>
                
                <!-- Save Indicator -->
                <div class="save-indicator text-sm text-gray-500" x-show="saveStatus">
                    <span x-show="saveStatus === 'saving'">Saving...</span>
                    <span x-show="saveStatus === 'saved'" class="text-green-600">Saved ✓</span>
                    <span x-show="saveStatus === 'error'" class="text-red-600">Error ✗</span>
                </div>
                
                <!-- Keyboard Shortcuts Help -->
                <button class="text-gray-500 hover:text-gray-700" title="Keyboard shortcuts">
                    <span class="kbd">?</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-white border-b border-gray-200">
        <div class="px-6">
            <div class="flex space-x-8">
                <template x-for="tab in [
                    {id: 'build', label: 'Build', enabled: true},
                    {id: 'preview', label: 'Preview', enabled: true},
                    {id: 'share', label: 'Share', enabled: true},
                    {id: 'results', label: 'Results', enabled: false},
                    {id: 'analytics', label: 'Analytics', enabled: false},
                    {id: 'settings', label: 'Settings', enabled: true}
                ]" :key="tab.id">
                    <button @click="tab.enabled && (activeTab = tab.id)" 
                            class="py-3 px-1 border-b-2 font-medium text-base transition-colors"
                            :class="tab.enabled ? (activeTab === tab.id ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200') : 'border-transparent text-gray-400 cursor-not-allowed'"
                            :disabled="!tab.enabled"
                            x-text="tab.label">
                    </button>
                </template>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="px-6 py-8">
        
        <!-- Build Tab Content -->
        <div x-show="activeTab === 'build'" class="max-w-4xl mx-auto relative">
            
            <!-- Survey Title and Description -->
            <div class="mb-8">
                <input type="text" 
                       value="Customer Satisfaction Survey"
                       class="text-3xl font-bold text-gray-900 mb-2 w-full bg-transparent border-0 focus:bg-gray-50 px-2 -mx-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       @input="debouncedAutosave">
                <input type="text"
                       value="Help us improve your dining experience by sharing your feedback"
                       class="text-gray-600 w-full bg-transparent border-0 focus:bg-gray-50 px-2 -mx-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       @input="debouncedAutosave">
            </div>

            <!-- Questions Container -->
            <div class="space-y-4">
                <template x-for="(question, index) in questions" :key="question.id">
                    <div class="block group relative bg-white rounded-lg border border-gray-200 hover:shadow-sm transition-all"
                         :class="selectedQuestion === question.id ? 'ring-2 ring-indigo-500 shadow-sm' : ''">
                        
                        <!-- Drag Handle -->
                        <div class="block-handle absolute -left-8 top-1/2 -translate-y-1/2">
                            <div class="text-gray-400 hover:text-gray-600 cursor-move p-1 hover:bg-gray-100 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Comment Indicator -->
                        <div class="comment-indicator"
                             :class="{'has-comments': getCommentCount(question.id) > 0}"
                             @click="toggleCommentThread(question.id)">
                            <div class="comment-bubble"
                                 :class="{
                                     'has-comments': getCommentCount(question.id) > 0,
                                     'has-unresolved': hasUnresolvedComments(question.id)
                                 }">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                    </path>
                                </svg>
                                <span x-show="getCommentCount(question.id) > 0" 
                                      class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                                      x-text="getCommentCount(question.id)"></span>
                            </div>
                        </div>
                        
                        <!-- Question Content -->
                        <div class="p-6" @click="selectQuestion(question.id)">
                            <!-- Question Type Badge and Number -->
                            <div class="flex items-center gap-3 mb-4">
                                <!-- Question Type Dropdown -->
                                <div class="relative inline-block">
                                    <button @click.stop="showQuestionTypes = showQuestionTypes === question.id ? null : question.id"
                                            @keydown.escape="showQuestionTypes = null"
                                            @keydown="handleDropdownKeydown($event, question.id)"
                                            class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full transition-all"
                                            :class="showQuestionTypes === question.id ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'">
                                        <span x-text="getQuestionTypeName(question.type)"></span>
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    
                                    <!-- Question Type Dropdown -->
                                    <div x-show="showQuestionTypes === question.id" 
                                         x-transition
                                         @click.away="showQuestionTypes = null"
                                         class="question-type-dropdown">
                                        <div class="max-h-[400px] overflow-y-auto">
                                            <!-- Recently Used -->
                                            <div x-show="recentlyUsedTypes.length > 0" class="pt-2 pb-1">
                                                <template x-for="type in recentlyUsedTypes" :key="'recent-' + type.id">
                                                    <button class="question-type-item"
                                                            :class="{ 'highlighted': isTypeHighlighted('recent-' + type.id) }"
                                                            @click="changeQuestionType(question.id, type.id)"
                                                            @mouseenter="setHighlightedType('recent-' + type.id)">
                                                        <span class="text-lg mr-3" x-text="type.icon"></span>
                                                        <span class="text-sm font-medium" x-text="type.name"></span>
                                                        <span class="ml-auto text-yellow-500 text-xs">★</span>
                                                    </button>
                                                </template>
                                                <div class="border-t border-gray-100 my-1"></div>
                                            </div>
                                            
                                            <!-- Categories -->
                                            <template x-for="(category, categoryName) in questionTypeCategories" :key="categoryName">
                                                <div>
                                                    <div class="px-4 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider" 
                                                         x-text="categoryName"></div>
                                                    <template x-for="type in category" :key="type.id">
                                                        <button class="question-type-item"
                                                                :class="{ 'highlighted': isTypeHighlighted(categoryName + '-' + type.id) }"
                                                                @click="changeQuestionType(question.id, type.id)"
                                                                @mouseenter="setHighlightedType(categoryName + '-' + type.id)">
                                                            <span class="text-lg mr-3" x-text="type.icon"></span>
                                                            <span class="text-sm font-medium" x-text="type.name"></span>
                                                        </button>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Question Number -->
                                <input type="text" 
                                       x-model="question.questionNumber"
                                       @click.stop
                                       @input="validateQuestionNumber(question.id); debouncedAutosave()"
                                       @blur="validateQuestionNumber(question.id)"
                                       class="flex-1 text-base font-medium text-gray-500 bg-transparent border-0 focus:bg-gray-50 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                       :class="{'text-red-500': !isQuestionNumberValid(question.id)}"
                                       placeholder="Q1, A1, 1.1, etc."
                                       title="Question number for research purposes">
                            </div>
                            
                            <!-- Question Text -->
                            <input type="text" 
                                   x-model="question.text"
                                   @click.stop
                                   @input="debouncedAutosave"
                                   class="text-lg font-medium text-gray-900 mb-4 w-full bg-transparent border-0 focus:bg-gray-50 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Type your question here...">
                            
                            <!-- Options List (Multiple Choice & Checkbox) -->
                            <div x-show="question.type === 'multiple_choice' || question.type === 'checkbox'" class="space-y-2">
                                <template x-for="(option, optionIndex) in question.options" :key="option.id">
                                    <div class="question-option">
                                        <!-- Option Drag Handle -->
                                        <div class="option-drag-handle">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- Radio/Checkbox -->
                                        <input :type="question.type === 'checkbox' || question.settings.allowMultiple ? 'checkbox' : 'radio'" 
                                               :name="question.id" 
                                               :class="question.type === 'checkbox' ? 'text-indigo-600 rounded' : 'text-indigo-600'" 
                                               disabled>
                                        
                                        <!-- Option Text -->
                                        <input type="text" 
                                               x-model="option.text"
                                               @click.stop
                                               @input="debouncedAutosave"
                                               @keydown.enter="addOption(question.id)"
                                               @keydown.backspace="option.text === '' && removeOption(question.id, option.id)"
                                               :data-option-id="option.id"
                                               class="flex-1 px-3 py-1.5 bg-white border-0 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all duration-200"
                                               placeholder="Option text...">
                                        
                                        <!-- Remove Option Button -->
                                        <button @click.stop="removeOption(question.id, option.id)"
                                                x-show="question.options.length > 2"
                                                class="option-remove">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                                
                                <!-- Add Option Button -->
                                <button @click.stop="addOption(question.id)"
                                        class="add-option-button">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span>Add option</span>
                                </button>
                            </div>
                            
                            <!-- Text Input -->
                            <div x-show="question.type === 'text_input'">
                                <textarea placeholder="Respondent will type their answer here..." 
                                          class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 cursor-not-allowed"
                                          rows="4" 
                                          disabled></textarea>
                            </div>
                            
                            <!-- Long Text -->
                            <div x-show="question.type === 'long_text'">
                                <textarea placeholder="Respondent will type their detailed answer here..." 
                                          class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 cursor-not-allowed"
                                          rows="8" 
                                          disabled></textarea>
                                <div class="mt-2 text-sm text-gray-500 text-right">
                                    <span>0</span> / <span x-text="question.settings?.maxLength || 500"></span> characters
                                </div>
                            </div>
                            
                            
                            <!-- Yes/No -->
                            <div x-show="question.type === 'yes_no'" class="flex gap-3">
                                <button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex-1">
                                    <svg class="w-5 h-5 mx-auto mb-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Yes</span>
                                </button>
                                <button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex-1">
                                    <svg class="w-5 h-5 mx-auto mb-1 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    <span class="text-sm font-medium">No</span>
                                </button>
                            </div>
                            
                            <!-- Dropdown -->
                            <div x-show="question.type === 'dropdown'">
                                <select class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed" disabled>
                                    <option>Select an option...</option>
                                    <template x-for="option in question.options" :key="option.id">
                                        <option x-text="option.text"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <!-- Star Rating -->
                            <div x-show="question.type === 'star_rating'" class="flex gap-2">
                                <template x-for="i in 5">
                                    <button class="text-3xl text-gray-300 hover:text-yellow-400 transition-colors">★</button>
                                </template>
                            </div>
                            
                            <!-- Number Scale -->
                            <div x-show="question.type === 'number_scale'" class="flex gap-2">
                                <template x-for="i in (question.settings?.maxValue || 10)">
                                    <button class="w-10 h-10 rounded-lg bg-gray-100 hover:bg-indigo-100 hover:text-indigo-600 transition-colors font-medium text-sm"
                                            x-text="i"></button>
                                </template>
                            </div>
                            
                            <!-- NPS Score -->
                            <div x-show="question.type === 'nps'">
                                <div class="flex gap-1">
                                    <template x-for="i in 11">
                                        <button class="w-10 h-10 rounded border border-gray-200 hover:border-indigo-500 transition-colors font-medium text-sm"
                                                :class="{
                                                    'bg-red-50 text-red-600 border-red-200': i-1 <= 6,
                                                    'bg-yellow-50 text-yellow-600 border-yellow-200': i-1 >= 7 && i-1 <= 8,
                                                    'bg-green-50 text-green-600 border-green-200': i-1 >= 9
                                                }"
                                                x-text="i-1"></button>
                                    </template>
                                </div>
                                <div class="flex justify-between mt-2 text-xs text-gray-500">
                                    <span>Not likely</span>
                                    <span>Very likely</span>
                                </div>
                            </div>
                            
                            <!-- Likert Scale -->
                            <div x-show="question.type === 'likert'" class="space-y-2">
                                <div class="flex gap-2 justify-between">
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Strongly Disagree</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Disagree</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Neutral</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Agree</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Strongly Agree</button>
                                </div>
                            </div>
                            
                            <!-- Slider -->
                            <div x-show="question.type === 'slider'" class="relative pt-6">
                                <input type="range" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                       :min="question.settings?.minValue || 0" 
                                       :max="question.settings?.maxValue || 100" 
                                       value="50"
                                       disabled>
                                <div class="flex justify-between text-sm text-gray-500 mt-2">
                                    <span x-text="question.settings?.minValue || 0"></span>
                                    <span class="text-indigo-600 font-medium">50</span>
                                    <span x-text="question.settings?.maxValue || 100"></span>
                                </div>
                            </div>
                            
                            <!-- Emoji Scale -->
                            <div x-show="question.type === 'emoji_scale'" class="flex gap-3 justify-center text-4xl">
                                <button class="hover:scale-110 transition-transform">😢</button>
                                <button class="hover:scale-110 transition-transform">😟</button>
                                <button class="hover:scale-110 transition-transform">😐</button>
                                <button class="hover:scale-110 transition-transform">🙂</button>
                                <button class="hover:scale-110 transition-transform">😊</button>
                            </div>
                            
                            <!-- Number Input -->
                            <div x-show="question.type === 'number'">
                                <input type="number" 
                                       placeholder="Enter a number..." 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Email Input -->
                            <div x-show="question.type === 'email'">
                                <input type="email" 
                                       placeholder="email@example.com" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Phone Input -->
                            <div x-show="question.type === 'phone'">
                                <input type="tel" 
                                       placeholder="+1 (555) 000-0000" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- URL Input -->
                            <div x-show="question.type === 'url'">
                                <input type="url" 
                                       placeholder="https://example.com" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Date Input -->
                            <div x-show="question.type === 'date'">
                                <input type="date" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Time Input -->
                            <div x-show="question.type === 'time'">
                                <input type="time" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Matrix Table -->
                            <div x-show="question.type === 'matrix'" class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="text-left p-2"></th>
                                            <th class="text-center p-2 text-sm font-normal text-gray-600">Column 1</th>
                                            <th class="text-center p-2 text-sm font-normal text-gray-600">Column 2</th>
                                            <th class="text-center p-2 text-sm font-normal text-gray-600">Column 3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-t border-gray-100">
                                            <td class="p-2 text-sm">Row 1</td>
                                            <td class="text-center p-2"><input type="radio" name="row1" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row1" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row1" disabled></td>
                                        </tr>
                                        <tr class="border-t border-gray-100">
                                            <td class="p-2 text-sm">Row 2</td>
                                            <td class="text-center p-2"><input type="radio" name="row2" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row2" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row2" disabled></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Ranking -->
                            <div x-show="question.type === 'ranking'" class="space-y-2">
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <span class="text-gray-400 cursor-move">⋮⋮</span>
                                    <span class="font-medium text-gray-500">1.</span>
                                    <span>First item to rank</span>
                                </div>
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <span class="text-gray-400 cursor-move">⋮⋮</span>
                                    <span class="font-medium text-gray-500">2.</span>
                                    <span>Second item to rank</span>
                                </div>
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <span class="text-gray-400 cursor-move">⋮⋮</span>
                                    <span class="font-medium text-gray-500">3.</span>
                                    <span>Third item to rank</span>
                                </div>
                            </div>
                            
                            <!-- Constant Sum -->
                            <div x-show="question.type === 'constant_sum'" class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <input type="number" value="0" min="0" max="100" class="w-20 px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-center" disabled>
                                    <span class="flex-1">Option 1</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="number" value="0" min="0" max="100" class="w-20 px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-center" disabled>
                                    <span class="flex-1">Option 2</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="number" value="0" min="0" max="100" class="w-20 px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-center" disabled>
                                    <span class="flex-1">Option 3</span>
                                </div>
                                <div class="text-right mt-2 p-3 bg-gray-50 rounded-lg">
                                    <span class="text-sm text-gray-600">Total: </span>
                                    <span class="font-medium">0 / 100</span>
                                </div>
                            </div>
                            
                            <!-- File Upload -->
                            <div x-show="question.type === 'file_upload'">
                                <div class="border-2 border-dashed border-gray-200 rounded-lg p-8 text-center hover:border-gray-300 transition-colors">
                                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-gray-600 mb-2">Drop files here or click to upload</p>
                                    <p class="text-sm text-gray-500">PDF, DOC, DOCX, JPG, PNG up to 10MB</p>
                                </div>
                            </div>
                            
                            <!-- Image Choice -->
                            <div x-show="question.type === 'image_choice'" class="grid grid-cols-3 gap-3">
                                <button class="relative group overflow-hidden rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition-colors">
                                    <div class="aspect-square bg-gray-100 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="p-2 text-sm text-center">Option 1</div>
                                </button>
                                <button class="relative group overflow-hidden rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition-colors">
                                    <div class="aspect-square bg-gray-100 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="p-2 text-sm text-center">Option 2</div>
                                </button>
                                <button class="relative group overflow-hidden rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition-colors">
                                    <div class="aspect-square bg-gray-100 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="p-2 text-sm text-center">Option 3</div>
                                </button>
                            </div>
                            
                            <!-- Signature -->
                            <div x-show="question.type === 'signature'">
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="h-32 border-b-2 border-gray-300 relative">
                                        <div class="absolute bottom-0 left-0 text-xs text-gray-400">Sign here</div>
                                    </div>
                                    <div class="mt-3 flex justify-end">
                                        <button class="text-sm text-gray-500 hover:text-gray-700">Clear signature</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Heat Map -->
                            <div x-show="question.type === 'heat_map'">
                                <div class="relative bg-gray-100 rounded-lg overflow-hidden">
                                    <div class="aspect-video flex items-center justify-center">
                                        <div class="text-center">
                                            <svg class="w-16 h-16 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            <p class="text-gray-500">Click anywhere on the image</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Sort -->
                            <div x-show="question.type === 'card_sort'" class="space-y-4">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Items to sort:</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <div class="px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-move">Item 1</div>
                                        <div class="px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-move">Item 2</div>
                                        <div class="px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-move">Item 3</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="p-4 border-2 border-dashed border-gray-200 rounded-lg min-h-[100px]">
                                        <h4 class="text-sm font-medium text-gray-500 mb-2">Category A</h4>
                                    </div>
                                    <div class="p-4 border-2 border-dashed border-gray-200 rounded-lg min-h-[100px]">
                                        <h4 class="text-sm font-medium text-gray-500 mb-2">Category B</h4>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Question Actions -->
                            <div class="mt-4 flex items-center space-x-4 text-sm text-gray-600">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <span class="toggle-switch toggle-switch-sm">
                                        <input type="checkbox" 
                                               x-model="question.required"
                                               @change="debouncedAutosave">
                                        <span class="toggle-slider"></span>
                                    </span>
                                    <span>Required</span>
                                </label>
                                <button class="hover:text-gray-700 transition-colors">Add Logic</button>
                                <button class="hover:text-gray-700 transition-colors">Duplicate</button>
                                <button @click.stop="selectQuestion(question.id)"
                                        class="hover:text-gray-700 transition-colors flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span>Settings</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Add Block Button -->
                <div class="flex items-center justify-center py-8">
                    <button @click="showSlashMenu = true" class="flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-xl">+</span>
                        <span>Add block or type / for commands</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Preview Tab Content -->
        <div x-show="activeTab === 'preview'" class="max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Survey Preview</h2>
                <div class="inline-flex bg-gray-100 rounded-lg p-1">
                    <template x-for="device in ['desktop', 'tablet', 'mobile']" :key="device">
                        <button @click="previewDevice = device"
                                class="px-4 py-2 rounded-md transition-all"
                                :class="previewDevice === device ? 'bg-white shadow-sm text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                x-text="device.charAt(0).toUpperCase() + device.slice(1)">
                        </button>
                    </template>
                </div>
            </div>
            
            <!-- Desktop Preview -->
            <div x-show="previewDevice === 'desktop'" class="mx-auto max-w-4xl">
                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <div class="px-8 py-6 border-b border-gray-200">
                        <h1 class="text-2xl font-bold text-gray-900">Customer Satisfaction Survey</h1>
                        <p class="mt-2 text-gray-600">Help us improve your dining experience by sharing your feedback</p>
                    </div>
                    <div class="px-8 py-6">
                        <template x-for="(question, idx) in questions.slice(0, 2)" :key="question.id">
                            <div class="mb-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-3" x-text="`${idx + 1}. ${question.text}`"></h3>
                                <!-- Preview content would go here -->
                            </div>
                        </template>
                    </div>
                    <div class="px-8 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                        <span class="text-sm text-gray-500">Page 1 of 1</span>
                        <button class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Submit</button>
                    </div>
                </div>
            </div>
            
            <!-- Tablet/Mobile Preview -->
            <div x-show="previewDevice === 'tablet' || previewDevice === 'mobile'" 
                 class="flex justify-center"
                 :class="previewDevice === 'tablet' ? 'px-20' : ''">
                <div class="device-frame bg-gray-900 rounded-[40px] p-3 shadow-2xl"
                     :style="previewDevice === 'tablet' ? 'width: 768px; height: 1024px;' : 'width: 375px; height: 812px;'">
                    <div class="w-full h-full bg-white rounded-[30px] overflow-hidden">
                        <div class="h-full overflow-y-auto">
                            <div class="px-6 py-6 border-b border-gray-200">
                                <h1 class="text-xl font-bold text-gray-900">Customer Satisfaction Survey</h1>
                                <p class="mt-1 text-gray-600 text-sm">Help us improve your experience</p>
                            </div>
                            <div class="px-6 py-6">
                                <template x-for="(question, idx) in questions.slice(0, 1)" :key="question.id">
                                    <div>
                                        <span class="text-xs font-medium text-gray-500 block mb-2">Question 1 of 3</span>
                                        <h3 class="text-base font-medium text-gray-900 mb-4" x-text="question.text"></h3>
                                        <!-- Preview content would go here -->
                                        <div class="mt-6 flex justify-between">
                                            <button class="text-gray-400" disabled>Previous</button>
                                            <button class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Next</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Share Tab Content -->
        <div x-show="activeTab === 'share'" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-sm p-8">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Share Survey</h3>
                <div class="flex items-center space-x-3 mb-8">
                    <input type="text" value="https://surveys.mindful.com/s/abc123" readonly 
                           class="flex-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700">
                    <button @click="navigator.clipboard.writeText('https://surveys.mindful.com/s/abc123')"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Copy Link
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="text-center">
                        <div class="bg-gray-100 h-48 w-48 mx-auto rounded-lg flex items-center justify-center mb-4">
                            <span class="text-gray-400">[QR Code]</span>
                        </div>
                        <button class="text-indigo-600 hover:text-indigo-700">Download QR Code</button>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 mb-2">Embed Code</h4>
                        <pre class="bg-gray-50 p-4 rounded-lg text-xs overflow-x-auto"><code>&lt;iframe src="https://surveys.mindful.com/s/abc123" width="100%" height="600"&gt;&lt;/iframe&gt;</code></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab Content -->
        <div x-show="activeTab === 'settings'" class="max-w-5xl mx-auto px-8 py-8">
            <div class="grid grid-cols-5 gap-10">
                <div class="col-span-1">
                    <nav class="space-y-0.5">
                        <template x-for="section in ['general', 'design', 'logic', 'integrations', 'versions']" :key="section">
                            <button @click="settingsSection = section" 
                                    class="w-full text-left px-3 py-2 rounded-md transition-colors text-base capitalize" 
                                    :class="settingsSection === section ? 'text-gray-900 bg-gray-100' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'"
                                    x-text="section">
                            </button>
                        </template>
                        <div class="pt-4 mt-4 border-t border-gray-200">
                            <button @click="settingsSection = 'danger'" 
                                    class="w-full text-left px-3 py-2 rounded-md transition-colors text-base text-red-600 hover:bg-red-50">
                                Danger Zone
                            </button>
                        </div>
                    </nav>
                </div>
                
                <div class="col-span-4">
                    <!-- Settings sections content -->
                    <div x-show="settingsSection === 'general'">
                        <h3 class="text-lg font-medium text-gray-900 mb-6">General Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Survey Name</label>
                                <input type="text" value="Customer Satisfaction Survey" 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
                                          rows="3">Help us improve your dining experience</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Slash Menu -->
    <div x-show="showSlashMenu" 
         @click.away="showSlashMenu = false" 
         x-transition 
         class="fixed z-50 bg-white rounded-lg shadow-2xl border border-gray-200 w-72 max-h-96 overflow-y-auto"
         :style="`top: ${slashMenuPosition.y}px; left: ${slashMenuPosition.x}px`">
        <div class="p-2">
            <input type="text" 
                   x-ref="slashSearch"
                   x-model="slashSearchQuery"
                   @keydown.escape="showSlashMenu = false"
                   @keydown.enter="selectFirstSlashItem()"
                   placeholder="Search blocks..."
                   class="w-full px-3 py-2 text-sm border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="pb-2">
            <template x-for="(category, categoryName) in getFilteredQuestionTypes()" :key="categoryName">
                <div x-show="category.length > 0">
                    <div class="px-3 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        <span x-text="categoryName"></span>
                    </div>
                    <template x-for="type in category" :key="type.id">
                        <button @click="addQuestionFromSlash(type.id); showSlashMenu = false"
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 flex items-center space-x-3 transition-colors">
                            <span class="text-lg" x-text="type.icon"></span>
                            <span class="text-sm" x-text="type.name"></span>
                        </button>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Comment Sidebar -->
    <div class="comment-sidebar-overlay" 
         :class="{ 'active': activeCommentThread }"
         @click="activeCommentThread = null"
         style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s;"></div>
    
    <div class="comment-sidebar" 
         :class="{ 'active': activeCommentThread }"
         style="position: fixed; right: 0; top: 0; bottom: 0; width: 400px; background: white; box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1); z-index: 1000; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
        <template x-if="activeCommentThread">
            <div class="h-full flex flex-col">
                <!-- Header -->
                <div class="p-5 border-b border-gray-200 bg-white sticky top-0 z-10">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-gray-900">Comments</h3>
                        <button @click="activeCommentThread = null" class="w-8 h-8 rounded-md flex items-center justify-center hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Question Context -->
                    <div class="bg-gray-50 p-3 rounded-lg text-sm">
                        <div class="text-xs text-gray-500">Commenting on:</div>
                        <div class="text-gray-900 font-medium mt-1" x-text="getQuestionText(activeCommentThread)"></div>
                    </div>
                </div>
                
                <!-- Comments List -->
                <div class="flex-1 overflow-y-auto p-5">
                    <div class="space-y-4">
                        <template x-for="comment in getCommentsForQuestion(activeCommentThread)" :key="comment.id">
                            <div class="bg-gray-50 p-4 rounded-lg transition-all" :class="{ 'opacity-60': comment.resolved }">
                                <!-- Comment content will be rendered here -->
                                <div class="text-sm text-gray-700" x-text="comment.text"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- New Comment Form -->
                <div class="p-5 border-t border-gray-200 bg-white">
                    <textarea x-model="newComment.text" 
                              @keydown.cmd.enter="addComment()"
                              placeholder="Add a comment..."
                              class="w-full p-3 border border-gray-200 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                              rows="3"></textarea>
                    
                    <div class="flex justify-end gap-2 mt-3">
                        <button @click="newComment = { text: '', type: null }" 
                                class="px-4 py-2 text-gray-600 hover:text-gray-700">
                            Cancel
                        </button>
                        <button @click="addComment()" 
                                :disabled="!newComment.text.trim()"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            Post Comment
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" :class="{ 'show': showSettings && selectedQuestion }">
        <template x-if="selectedQuestion">
            <div class="flex flex-col h-full">
                <!-- Settings Header -->
                <div class="settings-header">
                    <h3 class="text-lg font-semibold text-gray-900">Question Settings</h3>
                    <button @click="showSettings = false" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <template x-for="tab in ['General', 'Validation', 'Logic', 'Display']" :key="tab">
                        <button @click="settingsTab = tab.toLowerCase()" 
                                class="settings-tab"
                                :class="{ 'active': settingsTab === tab.toLowerCase() }"
                                x-text="tab">
                        </button>
                    </template>
                </div>
                
                <!-- Settings Content -->
                <div class="settings-content">
                    <!-- General Tab -->
                    <div x-show="settingsTab === 'general'">
                        <div class="settings-section">
                            <h4 class="settings-section-title">Basic Settings</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Label</label>
                                    <input type="text" 
                                           x-model="getSelectedQuestion().questionNumber"
                                           @input="validateQuestionNumber(selectedQuestion); debouncedAutosave()"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                           :class="{'border-red-300': !isQuestionNumberValid(selectedQuestion)}"
                                           placeholder="Q1, A1, 1.1, etc.">
                                    <p x-show="!isQuestionNumberValid(selectedQuestion)" 
                                       class="mt-1 text-sm text-red-600">
                                        Duplicate with: <span x-text="getDuplicateQuestionText(selectedQuestion)"></span>
                                    </p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Required</label>
                                    <label class="flex items-center space-x-3">
                                        <span class="toggle-switch">
                                            <input type="checkbox" 
                                                   x-model="getSelectedQuestion().required"
                                                   @change="debouncedAutosave">
                                            <span class="toggle-slider"></span>
                                        </span>
                                        <span class="text-sm text-gray-600">Respondents must answer this question</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Other tabs content will be added in getSettingsContent() method -->
                    <div x-html="getSettingsContent()"></div>
                </div>
            </div>
        </template>
    </div>

    <!-- AI Chat Widget -->
    <div class="ai-chat-widget" x-data="{ chatOpen: false }">
        <!-- Minimized State - Chat Button -->
        <div x-show="!chatOpen" x-transition class="ai-chat-button" @click="chatOpen = true">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
        </div>
        
        <!-- Expanded State - Chat Window -->
        <div x-show="chatOpen" x-transition class="ai-chat-window">
            <!-- Chat Header -->
            <div class="ai-chat-header" style="padding: 16px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: space-between;">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <div>
                        <h3 class="font-semibold">AI Assistant</h3>
                        <p class="text-sm opacity-90">Here to help you build better surveys</p>
                    </div>
                </div>
                <button @click="chatOpen = false" class="text-white opacity-80 hover:opacity-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Chat Body -->
            <div class="ai-chat-body" style="flex: 1; padding: 20px; overflow-y: auto; background: #f9fafb;">
                <!-- Welcome Message -->
                <div class="mb-4">
                    <div class="text-base text-gray-600 mb-3">Hi! I can help you:</div>
                    <div class="space-y-2">
                        <div class="ai-suggestion" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s;" @click="processAISuggestion('Create a customer satisfaction survey')">
                            <div class="font-medium text-base">Create a complete survey</div>
                            <div class="text-base text-gray-500">Tell me your goal and I'll build it</div>
                        </div>
                        <div class="ai-suggestion" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s;" @click="processAISuggestion('Add demographic questions')">
                            <div class="font-medium text-base">Add question blocks</div>
                            <div class="text-base text-gray-500">Demographics, NPS, rating scales</div>
                        </div>
                        <div class="ai-suggestion" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s;" @click="processAISuggestion('Improve my survey questions')">
                            <div class="font-medium text-base">Improve existing questions</div>
                            <div class="text-base text-gray-500">Make them clearer and unbiased</div>
                        </div>
                        <div class="ai-suggestion" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s;" @click="processAISuggestion('Add branching logic')">
                            <div class="font-medium text-base">Set up logic flows</div>
                            <div class="text-base text-gray-500">Skip logic, branching, conditions</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages Area -->
                <div id="chat-messages" class="space-y-3">
                    <!-- Messages will appear here -->
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="ai-chat-input-area" style="padding: 16px; border-top: 1px solid #e5e7eb; background: white;">
                <div class="flex space-x-2">
                    <input type="text" 
                           placeholder="Ask me anything about your survey..." 
                           class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                           @keydown.enter="sendMessage($event.target.value); $event.target.value = ''">
                    <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Version History Panel -->
    <div x-show="versionPanelOpen" 
         x-transition
         @click="versionPanelOpen = false"
         class="fixed inset-0 bg-black bg-opacity-20 z-[999]" 
         style="display: none;">
    </div>
    
    <div class="version-history-panel" :class="{ 'open': versionPanelOpen, 'expanded': showVisualDiff }" @click.stop
         style="position: fixed; right: 0; top: 0; height: 100vh; width: 480px; background: white; box-shadow: -4px 0 24px rgba(0, 0, 0, 0.08); z-index: 1000; transform: translateX(100%); transition: all 0.3s ease-out;">
        <!-- Panel Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Version history</h2>
                <p class="text-sm text-gray-500 mt-1">Track all changes to your survey</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Visual Comparison Toggle -->
                <div class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-md text-sm">
                    <input type="checkbox" id="showVisualDiff" x-model="showVisualDiff" class="text-indigo-600 rounded">
                    <label for="showVisualDiff" class="text-gray-700 select-none cursor-pointer">Show changes in preview</label>
                </div>
                <button @click="versionPanelOpen = false" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Version Timeline -->
            <div class="overflow-y-auto p-6 relative" :class="showVisualDiff ? 'w-96 border-r border-gray-200' : 'flex-1'">
                <!-- Version items will be rendered here -->
                <div class="space-y-6">
                    <template x-for="version in versions" :key="version.id">
                        <div class="relative pl-8">
                            <div class="absolute left-1.5 w-3 h-3 bg-white border-2 rounded-full"
                                 :class="version.current ? 'bg-green-500 border-green-500' : 'border-gray-300'"></div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow cursor-pointer"
                                 :class="{ 'ring-2 ring-indigo-500': selectedVersion === version.id }"
                                 @click="selectVersion(version.id)">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium" x-text="`Version ${version.number}`"></span>
                                        <span x-show="version.current" class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs">Current</span>
                                    </div>
                                    <span class="text-sm text-gray-500" x-text="version.time"></span>
                                </div>
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs text-white"
                                         :class="version.author.color"
                                         x-text="version.author.initials"></div>
                                    <span class="text-sm text-gray-700" x-text="version.author.name"></span>
                                </div>
                                <div class="space-y-2">
                                    <template x-for="change in version.changes" :key="change.id">
                                        <div class="change-item"
                                             :class="{
                                                 'change-added': change.type === 'added',
                                                 'change-modified': change.type === 'modified',
                                                 'change-removed': change.type === 'removed'
                                             }">
                                            <span class="font-medium" x-text="change.label"></span>
                                            <span x-text="change.description"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Visual Diff View -->
            <div x-show="showVisualDiff" class="flex-1 bg-gray-50 p-6">
                <div class="grid grid-cols-2 gap-6 h-full">
                    <!-- Preview content will be rendered here -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                            <h3 class="font-medium">Previous Version</h3>
                        </div>
                        <div class="space-y-4">
                            <!-- Previous version content -->
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                            <h3 class="font-medium">Current Version</h3>
                        </div>
                        <div class="space-y-4">
                            <!-- Current version content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Main Alpine.js component
        function surveyEditor() {
            return {
                // Core state
                status: 'draft',
                activeTab: 'build',
                selectedQuestion: null,
                showSettings: false,
                settingsTab: 'general',
                saveStatus: null,
                showSlashMenu: false,
                slashMenuPosition: { x: 0, y: 0 },
                slashSearchQuery: '',
                activeCommentThread: null,
                newComment: { text: '', type: null },
                commentTypes: ['blocker', 'suggestion', 'question', 'idea', 'approval'],
                versionPanelOpen: false,
                selectedVersion: null,
                showVisualDiff: false,
                previewDevice: 'desktop',
                settingsSection: 'general',
                recentlyUsedTypes: [],
                highlightedType: null,
                hoveredChange: null,
                
                // Questions data
                questions: [],
                
                // Comments data
                comments: {},
                
                // Version history
                versions: [
                    {
                        id: 3,
                        number: 3,
                        current: true,
                        time: '2:34 PM',
                        author: { initials: 'SC', name: 'Sarah Chen', color: 'bg-purple-500' },
                        changes: [
                            { id: 1, type: 'added', label: '+ Added:', description: 'Demographics block with age and location questions' },
                            { id: 2, type: 'modified', label: '~ Modified:', description: 'Survey title from "Feedback Survey" to "Customer Satisfaction Survey"' }
                        ]
                    },
                    {
                        id: 2,
                        number: 2,
                        current: false,
                        time: '11:20 AM',
                        author: { initials: 'MJ', name: 'Mike Johnson', color: 'bg-green-500' },
                        changes: [
                            { id: 3, type: 'added', label: '+ Added:', description: 'NPS score question' },
                            { id: 4, type: 'removed', label: '- Removed:', description: 'Duplicate satisfaction rating' }
                        ]
                    }
                ],
                
                // Extend surveyBuilderData
                ...window.surveyBuilderData(),
                
                // Initialize
                init() {
                    // Create initial questions with proper data
                    const q1Id = Date.now();
                    const q2Id = Date.now() + 1;
                    const q3Id = Date.now() + 2;
                    
                    this.questions = [
                        {
                            id: q1Id,
                            type: 'multiple_choice',
                            questionNumber: 'Q1',
                            text: 'How satisfied were you with your overall dining experience?',
                            required: true,
                            description: '',
                            settings: { allowMultiple: false, randomizeOptions: false, displayFormat: 'vertical' },
                            validation: {},
                            options: [
                                { id: Date.now() + 10, text: 'Very Satisfied' },
                                { id: Date.now() + 11, text: 'Satisfied' },
                                { id: Date.now() + 12, text: 'Neutral' },
                                { id: Date.now() + 13, text: 'Dissatisfied' },
                                { id: Date.now() + 14, text: 'Very Dissatisfied' }
                            ]
                        },
                        {
                            id: q2Id,
                            type: 'text_input',
                            questionNumber: 'Q2',
                            text: 'What could we improve about your experience?',
                            required: false,
                            description: '',
                            settings: { placeholder: 'Type your answer here...', maxLength: 500 },
                            validation: {},
                            options: []
                        },
                        {
                            id: q3Id,
                            type: 'nps',
                            questionNumber: 'Q3',
                            text: 'How likely are you to recommend us to a friend?',
                            required: true,
                            description: '',
                            settings: { leftLabel: 'Not likely', rightLabel: 'Very likely' },
                            validation: {},
                            options: []
                        }
                    ];
                    
                    // Initialize comments for demo
                    this.comments = {
                        [q1Id]: [
                            { id: 1, text: 'Should we include a "Very Satisfied" option?', type: 'suggestion', author: 'Sarah Chen', resolved: false },
                            { id: 2, text: 'Consider using a 7-point scale', type: 'idea', author: 'Mike Johnson', resolved: false }
                        ],
                        [q2Id]: [
                            { id: 3, text: 'Character limit needed?', type: 'question', author: 'Sarah Chen', resolved: false }
                        ]
                    };
                    
                    // Set first question as selected
                    this.selectedQuestion = q1Id;
                    
                    // Initialize shortcuts
                    this.$watch('activeTab', () => this.saveStatus = 'saved');
                },
                
                // Question management
                addQuestion(type) {
                    const id = Date.now();
                    const questionNumber = `Q${this.questions.length + 1}`;
                    
                    const newQuestion = {
                        id,
                        type,
                        questionNumber,
                        text: 'What is your question?',
                        required: false,
                        description: '',
                        settings: this.getDefaultSettings(type),
                        validation: {},
                        options: this.getDefaultOptions(type)
                    };
                    
                    this.questions.push(newQuestion);
                    this.selectedQuestion = id;
                    
                    // Track recently used
                    this.updateRecentlyUsed(type);
                    
                    // Auto-save
                    this.autoSave();
                },
                
                getDefaultSettings(type) {
                    const defaults = {
                        multiple_choice: { allowMultiple: false, randomizeOptions: false, displayFormat: 'vertical' },
                        checkbox: { minSelections: 0, maxSelections: null },
                        rating: { scale: 5, showLabels: true },
                        likert: { scale: ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'] },
                        number_scale: { minValue: 1, maxValue: 10 },
                        text_input: { placeholder: 'Type your answer here...' },
                        long_text: { placeholder: 'Type your detailed answer here...', maxLength: 500 }
                    };
                    return defaults[type] || {};
                },
                
                getDefaultOptions(type) {
                    const defaults = {
                        multiple_choice: [
                            { id: Date.now() + 1, text: 'Option 1' },
                            { id: Date.now() + 2, text: 'Option 2' },
                            { id: Date.now() + 3, text: 'Option 3' }
                        ],
                        checkbox: [
                            { id: Date.now() + 1, text: 'Option 1' },
                            { id: Date.now() + 2, text: 'Option 2' },
                            { id: Date.now() + 3, text: 'Option 3' }
                        ],
                        dropdown: [
                            { id: Date.now() + 1, text: 'Select option 1' },
                            { id: Date.now() + 2, text: 'Select option 2' },
                            { id: Date.now() + 3, text: 'Select option 3' }
                        ]
                    };
                    return defaults[type] || [];
                },
                
                selectQuestion(id) {
                    this.selectedQuestion = id;
                    this.showSettings = true;
                },
                
                changeQuestionType(questionId, newType) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (question) {
                        question.type = newType;
                        question.settings = this.getDefaultSettings(newType);
                        question.options = this.getDefaultOptions(newType);
                        this.updateRecentlyUsed(newType);
                        this.autoSave();
                    }
                    this.showQuestionTypes = null;
                },
                
                updateRecentlyUsed(type) {
                    // Remove if exists
                    this.recentlyUsedTypes = this.recentlyUsedTypes.filter(t => t.id !== type);
                    
                    // Add to beginning
                    const typeData = this.findQuestionType(type);
                    if (typeData) {
                        this.recentlyUsedTypes.unshift(typeData);
                        // Keep only last 3
                        this.recentlyUsedTypes = this.recentlyUsedTypes.slice(0, 3);
                    }
                },
                
                findQuestionType(typeId) {
                    for (const [category, types] of Object.entries(this.questionTypeCategories)) {
                        const found = types.find(t => t.id === typeId);
                        if (found) return found;
                    }
                    return null;
                },
                
                getQuestionTypeName(type) {
                    const typeData = this.findQuestionType(type);
                    return typeData ? typeData.name : type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                },
                
                getQuestionTypeCategories() {
                    // Filter based on search
                    if (!this.slashSearchQuery) return this.questionTypeCategories;
                    
                    const query = this.slashSearchQuery.toLowerCase();
                    const filtered = {};
                    
                    for (const [category, types] of Object.entries(this.questionTypeCategories)) {
                        const matchedTypes = types.filter(t => 
                            t.name.toLowerCase().includes(query) ||
                            t.id.toLowerCase().includes(query)
                        );
                        if (matchedTypes.length > 0) {
                            filtered[category] = matchedTypes;
                        }
                    }
                    
                    return filtered;
                },
                
                getFilteredQuestionTypes() {
                    return this.getQuestionTypeCategories();
                },
                
                addOption(questionId) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (question && question.options) {
                        question.options.push({
                            id: Date.now(),
                            text: `Option ${question.options.length + 1}`
                        });
                        this.autoSave();
                    }
                },
                
                removeOption(questionId, optionId) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (question && question.options) {
                        question.options = question.options.filter(o => o.id !== optionId);
                        this.autoSave();
                    }
                },
                
                getSelectedQuestion() {
                    return this.questions.find(q => q.id === this.selectedQuestion) || {};
                },
                
                getQuestionText(questionId) {
                    const question = this.questions.find(q => q.id === questionId);
                    return question ? question.text : '';
                },
                
                // Comment management
                toggleCommentThread(questionId) {
                    this.activeCommentThread = this.activeCommentThread === questionId ? null : questionId;
                },
                
                getCommentsForQuestion(questionId) {
                    return this.comments[questionId] || [];
                },
                
                getCommentCount(questionId) {
                    const comments = this.getCommentsForQuestion(questionId);
                    return comments.filter(c => !c.resolved).length;
                },
                
                hasUnresolvedComments(questionId) {
                    const comments = this.getCommentsForQuestion(questionId);
                    return comments.some(c => !c.resolved && c.type === 'blocker');
                },
                
                addComment() {
                    if (!this.activeCommentThread || !this.newComment.text.trim()) return;
                    
                    const comment = {
                        id: Date.now(),
                        text: this.newComment.text,
                        type: this.newComment.type,
                        author: { 
                            initials: 'GP', 
                            name: 'Current User', 
                            role: 'Editor' 
                        },
                        timestamp: new Date(),
                        resolved: false
                    };
                    
                    if (!this.comments[this.activeCommentThread]) {
                        this.comments[this.activeCommentThread] = [];
                    }
                    
                    this.comments[this.activeCommentThread].push(comment);
                    this.newComment = { text: '', type: null };
                    this.autoSave();
                },
                
                toggleResolve(commentId) {
                    for (const [questionId, questionComments] of Object.entries(this.comments)) {
                        const comment = questionComments.find(c => c.id === commentId);
                        if (comment) {
                            comment.resolved = !comment.resolved;
                            this.autoSave();
                            break;
                        }
                    }
                },
                
                deleteComment(commentId) {
                    for (const [questionId, questionComments] of Object.entries(this.comments)) {
                        const index = questionComments.findIndex(c => c.id === commentId);
                        if (index !== -1) {
                            questionComments.splice(index, 1);
                            this.autoSave();
                            break;
                        }
                    }
                },
                
                getCommentTypeIcon(type) {
                    const icons = {
                        blocker: '🚫',
                        suggestion: '💡',
                        question: '❓',
                        idea: '✨',
                        approval: '✅'
                    };
                    return icons[type] || '💬';
                },
                
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                },
                
                // Version management
                selectVersion(versionId) {
                    this.selectedVersion = versionId;
                },
                
                // Auto-save
                autoSave() {
                    this.saveStatus = 'saving';
                    // Simulate save
                    setTimeout(() => {
                        this.saveStatus = 'saved';
                        setTimeout(() => {
                            this.saveStatus = null;
                        }, 2000);
                    }, 500);
                },
                
                debouncedAutosave() {
                    if (this.autosaveTimeout) clearTimeout(this.autosaveTimeout);
                    this.autosaveTimeout = setTimeout(() => this.autoSave(), 1000);
                },
                
                // Dropdown keyboard navigation
                handleDropdownKeydown(event, questionId) {
                    // Handle arrow keys, enter, etc.
                    if (event.key === 'Escape') {
                        this.showQuestionTypes = null;
                    }
                },
                
                setHighlightedType(typeKey) {
                    this.highlightedType = typeKey;
                },
                
                isTypeHighlighted(typeKey) {
                    return this.highlightedType === typeKey;
                },
                
                // Slash menu
                addQuestionFromSlash(type) {
                    this.addQuestion(type);
                    this.showSlashMenu = false;
                },
                
                selectFirstSlashItem() {
                    // Implement keyboard selection
                },
                
                // AI Assistant
                processAISuggestion(suggestion) {
                    console.log('AI Suggestion:', suggestion);
                    // Implement AI processing
                },
                
                sendMessage(message) {
                    console.log('Send message:', message);
                    // Implement chat
                },
                
                // Settings content
                getSettingsContent() {
                    // Return dynamic settings content based on question type and tab
                    return '';
                },
                
            };
        }
    </script>
</body>
</html>