<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Editor - Notion-Inspired Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Survey Builder Data Function - Define before Alpine.js loads
        window.surveyBuilderData = function() {
            return {
                selectedQuestion: null,
                showSettings: false,
                showQuestionTypes: null,
                // Question type categories - 30+ types organized intuitively
                questionTypeCategories: {
                    essentials: [
                        { id: 'text_input', name: 'Short Text', icon: '💬' },
                        { id: 'long_text', name: 'Long Text', icon: '📝' },
                        { id: 'multiple_choice', name: 'Multiple Choice', icon: '🔘' },
                        { id: 'checkbox', name: 'Checkboxes', icon: '☑️' },
                        { id: 'dropdown', name: 'Dropdown', icon: '▼' },
                        { id: 'yes_no', name: 'Yes/No', icon: '👍' }
                    ],
                    rating: [
                        { id: 'star_rating', name: 'Star Rating', icon: '⭐' },
                        { id: 'number_scale', name: 'Number Scale', icon: '🔢' },
                        { id: 'nps', name: 'NPS Score', icon: '🎯' },
                        { id: 'likert', name: 'Likert Scale', icon: '📊' },
                        { id: 'slider', name: 'Slider', icon: '🎚️' },
                        { id: 'emoji_scale', name: 'Emoji Scale', icon: '😊' }
                    ],
                    input: [
                        { id: 'number', name: 'Number', icon: '💯' },
                        { id: 'email', name: 'Email', icon: '✉️' },
                        { id: 'phone', name: 'Phone', icon: '📱' },
                        { id: 'url', name: 'Website', icon: '🌐' },
                        { id: 'date', name: 'Date', icon: '📅' },
                        { id: 'time', name: 'Time', icon: '🕐' }
                    ],
                    advanced: [
                        { id: 'matrix', name: 'Matrix Table', icon: '⊞' },
                        { id: 'ranking', name: 'Rank Order', icon: '📋' },
                        { id: 'constant_sum', name: 'Constant Sum', icon: '💯' },
                        { id: 'max_diff', name: 'MaxDiff', icon: '⚖️' },
                        { id: 'side_by_side', name: 'Side by Side', icon: '📊' },
                        { id: 'card_sort', name: 'Card Sort', icon: '🗂️' }
                    ],
                    media: [
                        { id: 'file_upload', name: 'File Upload', icon: '📎' },
                        { id: 'image_choice', name: 'Image Choice', icon: '🖼️' },
                        { id: 'signature', name: 'Signature', icon: '✍️' },
                        { id: 'drawing', name: 'Drawing', icon: '🎨' },
                        { id: 'video_response', name: 'Video', icon: '📹' },
                        { id: 'audio_response', name: 'Audio', icon: '🎤' }
                    ],
                    interactive: [
                        { id: 'heat_map', name: 'Heat Map', icon: '🔥' },
                        { id: 'hot_spot', name: 'Hot Spot', icon: '🎯' },
                        { id: 'map_location', name: 'Map Location', icon: '📍' },
                        { id: 'priority_grid', name: 'Priority Grid', icon: '⊞' }
                    ]
                },
                
                debouncedAutosave() {
                    // Placeholder for auto-save functionality
                    console.log('Auto-saving...');
                },
                
                validateQuestionNumber(questionId) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (!question) return;
                    
                    // Check for duplicates
                    const duplicates = this.questions.filter(q => 
                        q.id !== questionId && 
                        q.questionNumber && 
                        q.questionNumber.trim().toLowerCase() === question.questionNumber.trim().toLowerCase()
                    );
                    
                    // Store validation result for this question
                    if (!this.questionNumberValidation) {
                        this.questionNumberValidation = {};
                    }
                    
                    this.questionNumberValidation[questionId] = {
                        isValid: duplicates.length === 0,
                        duplicateWith: duplicates.length > 0 ? duplicates[0].id : null
                    };
                },
                
                isQuestionNumberValid(questionId) {
                    if (!this.questionNumberValidation || !this.questionNumberValidation[questionId]) {
                        return true; // Default to valid if not yet validated
                    }
                    return this.questionNumberValidation[questionId].isValid;
                },
                
                getDuplicateQuestionText(questionId) {
                    if (!this.questionNumberValidation || !this.questionNumberValidation[questionId]) {
                        return '';
                    }
                    
                    const duplicateId = this.questionNumberValidation[questionId].duplicateWith;
                    if (!duplicateId) return '';
                    
                    const duplicateQuestion = this.questions.find(q => q.id === duplicateId);
                    if (!duplicateQuestion) return '';
                    
                    // Return a truncated version of the duplicate question's text
                    const text = duplicateQuestion.text || 'Untitled question';
                    return text.length > 30 ? text.substring(0, 30) + '...' : text;
                }
            }
        }
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        // Apply custom styles after Tailwind loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a moment for Tailwind to fully load
            setTimeout(() => {
                const style = document.createElement('style');
                style.textContent = `
                    /* Override ALL Tailwind form styles globally */
                    input:not([type='checkbox']):not([type='radio']):not([type='file']),
                    textarea,
                    select {
                        border-color: rgb(229 231 235) !important;
                    }
                    
                    /* Settings panel specific overrides with maximum specificity */
                    .settings-panel input[type='text'],
                    .settings-panel input[type='number'],
                    .settings-panel input[type='email'],
                    .settings-panel input[type='password'],
                    .settings-panel input[type='search'],
                    .settings-panel input[type='tel'],
                    .settings-panel input[type='url'],
                    .settings-panel textarea,
                    .settings-panel select {
                        border-color: rgb(229 231 235) !important;
                        border-width: 1px !important;
                        border-style: solid !important;
                    }
                    
                    .settings-panel input[type='text']:focus,
                    .settings-panel input[type='number']:focus,
                    .settings-panel input[type='email']:focus,
                    .settings-panel input[type='password']:focus,
                    .settings-panel input[type='search']:focus,
                    .settings-panel input[type='tel']:focus,
                    .settings-panel input[type='url']:focus,
                    .settings-panel textarea:focus,
                    .settings-panel select:focus {
                        border-color: transparent !important;
                        outline: none !important;
                        box-shadow: 0 0 0 2px rgb(99 102 241) !important;
                    }
                    
                    /* Override Tailwind forms plugin black borders */
                    input::-webkit-outer-spin-button,
                    input::-webkit-inner-spin-button {
                        -webkit-appearance: none;
                        margin: 0;
                    }
                    
                    input[type=number] {
                        -moz-appearance: textfield;
                    }
                `;
                document.head.appendChild(style);
            }, 100);
        });
    </script>
    <style>
        /* Override Tailwind's form-input black borders */
        [type='text'],
        [type='email'],
        [type='url'],
        [type='password'],
        [type='number'],
        [type='date'],
        [type='datetime-local'],
        [type='month'],
        [type='search'],
        [type='tel'],
        [type='time'],
        [type='week'],
        [multiple],
        textarea,
        select {
            border-color: rgb(229 231 235) !important; /* gray-200 */
        }
        
        /* Fix black borders in settings panel with higher specificity */
        .settings-panel [type='text'],
        .settings-panel [type='email'],
        .settings-panel [type='url'],
        .settings-panel [type='password'],
        .settings-panel [type='number'],
        .settings-panel [type='date'],
        .settings-panel [type='datetime-local'],
        .settings-panel [type='month'],
        .settings-panel [type='search'],
        .settings-panel [type='tel'],
        .settings-panel [type='time'],
        .settings-panel [type='week'],
        .settings-panel [multiple],
        .settings-panel textarea,
        .settings-panel select {
            border-color: rgb(229 231 235) !important; /* gray-200 */
        }
        
        /* Focus states for settings panel */
        .settings-panel [type='text']:focus,
        .settings-panel [type='email']:focus,
        .settings-panel [type='url']:focus,
        .settings-panel [type='password']:focus,
        .settings-panel [type='number']:focus,
        .settings-panel [type='date']:focus,
        .settings-panel [type='datetime-local']:focus,
        .settings-panel [type='month']:focus,
        .settings-panel [type='search']:focus,
        .settings-panel [type='tel']:focus,
        .settings-panel [type='time']:focus,
        .settings-panel [type='week']:focus,
        .settings-panel [multiple]:focus,
        .settings-panel textarea:focus,
        .settings-panel select:focus {
            border-color: transparent !important;
            outline: 2px solid transparent !important;
            outline-offset: 2px !important;
            box-shadow: 0 0 0 2px rgb(99 102 241) !important; /* indigo ring */
        }
        
        /* Custom styles for Notion-like appearance */
        .block-handle {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .block:hover .block-handle {
            opacity: 1;
        }
        .block-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .block:hover .block-actions {
            opacity: 1;
        }
        .slash-menu {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: slideUp 0.2s ease-out;
        }
        [contenteditable]:focus {
            outline: none;
            background-color: #f9fafb;
            border-radius: 4px;
        }
        .save-indicator {
            transition: opacity 0.3s;
        }
        
        /* Smooth animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .block {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Tab transitions */
        .tab {
            position: relative;
        }
        
        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #6366f1;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .tab.active::after {
            transform: scaleX(1);
        }
        
        /* Keyboard shortcut hint */
        .kbd {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 14px;
            font-family: monospace;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Device Frame Styles */
        .device-frame {
            position: relative;
            transform: scale(0.7);
            transform-origin: top center;
        }
        
        .device-frame::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -15px;
            width: 3px;
            height: 60px;
            background: #1a1a1a;
            border-radius: 2px 0 0 2px;
            transform: translateY(-50%);
        }
        
        .device-frame::after {
            content: '';
            position: absolute;
            top: 20%;
            right: -15px;
            width: 3px;
            height: 40px;
            background: #1a1a1a;
            border-radius: 0 2px 2px 0;
        }
        
        /* Preview device selector active state */
        .preview-device-btn {
            transition: all 0.2s ease;
        }
        
        /* AI Assistant Chat Widget Styles */
        .ai-chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }
        
        .ai-chat-button {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ai-chat-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .ai-chat-window {
            position: absolute;
            bottom: 72px;
            right: 0;
            width: 380px;
            height: 600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ai-chat-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ai-chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
        }
        
        .ai-chat-input-area {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }
        
        .ai-suggestion {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-suggestion:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        /* Collaboration Styles */
        .collab-avatars {
            display: flex;
            align-items: center;
            margin-left: 16px;
        }
        
        .collab-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e5e7eb;
            border: 2px solid white;
            margin-left: -8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
        }
        
        .collab-avatar:first-child {
            margin-left: 0;
        }
        
        .activity-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            margin-left: 6px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Version History Styles */
        .version-badge {
            background: #f3f4f6;
            color: #6b7280;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .version-badge:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        /* Version History Panel */
        .version-history-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 480px;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.08);
            z-index: 1000;
            transform: translateX(100%);
            transition: all 0.3s ease-out;
        }
        
        .version-history-panel.open {
            transform: translateX(0);
        }
        
        .version-history-panel.expanded {
            width: 90vw;
            max-width: 1400px;
        }
        
        .version-item {
            position: relative;
            padding-left: 32px;
        }
        
        .version-item::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 28px;
            bottom: -24px;
            width: 2px;
            background: #e5e7eb;
        }
        
        .version-item:last-child::before {
            display: none;
        }
        
        .version-dot {
            position: absolute;
            left: 6px;
            top: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e5e7eb;
        }
        
        .version-item.current .version-dot {
            background: #10b981;
            border-color: #10b981;
        }
        
        .version-item:hover .version-dot {
            border-color: #6366f1;
        }
        
        .change-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .change-added {
            background: #d1fae5;
            color: #065f46;
        }
        
        .change-modified {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .change-removed {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .diff-inline {
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .diff-added {
            background: #d1fae5;
            color: #065f46;
            text-decoration: none;
        }
        
        .diff-removed {
            background: #fee2e2;
            color: #991b1b;
            text-decoration: line-through;
        }
        
        /* Version Preview Split Screen */
        .version-preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            height: calc(100vh - 200px);
            overflow: hidden;
        }
        
        .version-preview-pane {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow-y: auto;
            position: relative;
        }
        
        .version-preview-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            z-index: 10;
        }
        
        /* Visual Diff Indicators */
        .diff-highlight-added {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
            animation: diffPulse 2s ease-in-out;
        }
        
        .diff-highlight-modified {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            animation: diffPulse 2s ease-in-out;
        }
        
        .diff-highlight-removed {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            opacity: 0.6;
            position: relative;
        }
        
        .diff-highlight-removed::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #ef4444;
        }
        
        @keyframes diffPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Change Preview Tooltip */
        .change-preview-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 16rem;
            display: none;
            overflow: visible;
            word-wrap: break-word;
            transform: translateY(0);
        }
        
        .change-preview-tooltip.show {
            display: block;
        }
        
        .change-preview-before,
        .change-preview-after {
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            font-size: 14px;
        }
        
        .change-preview-before {
            background: #fee2e2;
            border: 1px solid #fecaca;
        }
        
        .change-preview-after {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
        }
        
        /* Version Comparison Toggle */
        .version-comparison-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .version-comparison-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        /* Improved Survey Builder Styles */
        
        /* Question Type Selector */
        .question-type-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            animation: slideUp 0.3s ease-out;
        }
        
        .question-type-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .question-type-button:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }
        
        .question-type-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 8px;
            color: #6366f1;
        }
        
        /* Question Options Management */
        .question-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .question-option:hover {
            background: #f3f4f6;
        }
        
        .option-drag-handle {
            color: #9ca3af;
            cursor: move;
            padding: 4px;
        }
        
        .option-drag-handle:hover {
            color: #6b7280;
        }
        
        
        .option-remove {
            color: #ef4444;
            cursor: pointer;
            padding: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .question-option:hover .option-remove {
            opacity: 1;
        }
        
        /* Add Option Button */
        .add-option-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: #6366f1;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-option-button:hover {
            color: #4f46e5;
            background: #eef2ff;
            border-radius: 6px;
        }
        
        /* Contextual Settings Panel */
        .settings-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 380px;
            height: 100vh;
            background: white;
            border-left: 1px solid #e5e7eb;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.08);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        
        .settings-panel.show {
            transform: translateX(0);
        }
        
        .settings-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        /* Tab Navigation */
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #fafafa;
            flex-shrink: 0;
        }
        
        .settings-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-tab:hover {
            color: #4b5563;
            background: #f3f4f6;
        }
        
        .settings-tab.active {
            color: #4f46e5;
            background: white;
            border-bottom-color: #4f46e5;
        }
        
        .settings-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .settings-section {
            margin-bottom: 24px;
        }
        
        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .2s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input:checked + .toggle-slider {
            background-color: #6366f1;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Smaller toggle switch for quick settings */
        .toggle-switch-sm {
            width: 36px;
            height: 20px;
        }
        
        .toggle-switch-sm .toggle-slider:before {
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
        }
        
        .toggle-switch-sm input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }
        
        /* Visual Radio Cards */
        .display-format-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .display-format-card {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .display-format-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .display-format-card.selected {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
        
        .display-format-card input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .display-format-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .display-format-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        
        /* Comment System Styles */
        .comment-indicator {
            position: absolute;
            right: -40px;
            top: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .block:hover .comment-indicator,
        .comment-indicator.has-comments {
            opacity: 1;
        }
        
        .comment-bubble {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .comment-bubble:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }
        
        .comment-bubble.has-comments {
            background: #fef3c7;
            border: 1px solid #fbbf24;
        }
        
        .comment-bubble.has-unresolved {
            background: #fee2e2;
            border: 1px solid #ef4444;
        }
        
        .comment-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        /* Comment Sidebar Styles */
        .comment-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .comment-sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .comment-sidebar {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 400px;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .comment-sidebar.active {
            transform: translateX(0);
        }
        
        /* Mobile responsive - bottom sheet pattern */
        @media (max-width: 768px) {
            .comment-sidebar {
                width: 100%;
                height: 70vh;
                top: auto;
                bottom: 0;
                transform: translateY(100%);
                border-radius: 16px 16px 0 0;
            }
            
            .comment-sidebar.active {
                transform: translateY(0);
            }
        }
        
        .comment-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .comment-sidebar-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .comment-sidebar-title h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .comment-sidebar-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .comment-sidebar-close:hover {
            background: #f3f4f6;
        }
        
        .comment-question-context {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .comment-question-text {
            color: #111827;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .comment-sidebar-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .comment-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .comment-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .comment-item:hover {
            background: #f3f4f6;
        }
        
        .comment-item.resolved {
            opacity: 0.6;
        }
        
        .comment-author {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #6366f1;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .comment-meta {
            flex: 1;
        }
        
        .comment-name {
            font-weight: 600;
            font-size: 14px;
            color: #111827;
        }
        
        .comment-role {
            font-size: 12px;
            color: #6b7280;
        }
        
        .comment-time {
            font-size: 12px;
            color: #9ca3af;
        }
        
        .comment-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .comment-badge.blocker {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .comment-badge.suggestion {
            background: #fef3c7;
            color: #92400e;
        }
        
        .comment-badge.question {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .comment-badge.idea {
            background: #e9d5ff;
            color: #6b21a8;
        }
        
        .comment-badge.approval {
            background: #d1fae5;
            color: #065f46;
        }
        
        .comment-badge.reference {
            background: #e5e7eb;
            color: #374151;
        }
        
        .comment-body {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .comment-actions {
            display: flex;
            gap: 12px;
            font-size: 13px;
        }
        
        .comment-action {
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .comment-action:hover {
            color: #4b5563;
        }
        
        .comment-sidebar-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }
        
        .comment-type-selector {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .comment-type-option {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            background: white;
            transition: all 0.2s;
        }
        
        .comment-type-option.selected {
            background: #eef2ff;
            border-color: #6366f1;
            color: #4f46e5;
        }
        
        .comment-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            resize: none;
            font-size: 14px;
            min-height: 80px;
            margin-bottom: 12px;
        }
        
        .comment-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .comment-submit {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        
        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        
        /* Drag Indicator */
        .dragging {
            opacity: 0.5;
            cursor: move;
        }
        
        .drag-placeholder {
            background: #eef2ff;
            border: 2px dashed #6366f1;
            border-radius: 8px;
            height: 80px;
            margin: 8px 0;
        }
        
        /* Question Card Enhanced */
        .question-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.2s;
        }
        
        .question-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #d1d5db;
        }
        
        .question-card.selected {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Ultra-thin Question Type Dropdown Styles */
        .question-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            width: 260px;
            max-height: 380px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            z-index: 50;
        }
        
        .question-type-dropdown-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .question-type-search-hint {
            padding: 8px 12px;
            font-size: 12px;
            color: #9ca3af;
            border-bottom: 1px solid #f3f4f6;
            background: #fafafa;
            display: none; /* Remove search hint */
        }
        
        .question-type-section {
            padding: 2px 0;
        }
        
        .question-type-section:first-child {
            padding-top: 6px;
        }
        
        .question-type-section:last-child {
            padding-bottom: 6px;
        }
        
        .question-type-section + .question-type-section {
            border-top: 1px solid #f3f4f6;
            margin-top: 2px;
            padding-top: 8px;
        }
        
        .question-type-section-title {
            padding: 4px 16px 2px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
        }
        
        .question-type-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            width: 100%;
            text-align: left;
            background: white;
            position: relative;
        }
        
        .question-type-item:hover {
            background-color: #f9fafb;
        }
        
        .question-type-item.highlighted {
            background-color: #eef2ff;
        }
        
        .question-type-item:hover::before,
        .question-type-item.highlighted::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: #6366f1;
        }
        
        .question-type-item-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            opacity: 0.8;
        }
        
        .question-type-item:hover .question-type-item-icon,
        .question-type-item.highlighted .question-type-item-icon {
            opacity: 1;
        }
        
        .question-type-item-name {
            font-size: 14px;
            color: #374151;
            flex: 1;
            font-weight: 500;
        }
        
        .question-type-item:hover .question-type-item-name {
            color: #111827;
        }
        
        .question-type-item.highlighted .question-type-item-name {
            color: #4f46e5;
        }
        
        .question-type-item-hint {
            font-size: 11px;
            color: #9ca3af;
            margin-left: auto;
            padding-left: 8px;
        }
        
        /* Divider style */
        /* Recently used star */
        .question-type-star {
            color: #fbbf24;
            font-size: 12px;
            margin-left: 6px;
        }
        
        .question-type-no-results {
            padding: 24px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
        }
        
        .question-drag-handle {
            position: absolute;
            left: -32px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            cursor: move;
            padding: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .question-card:hover .question-drag-handle {
            opacity: 1;
        }
        
        /* Inline Editing */
        .question-text-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 16px;
            font-weight: 500;
            border: 1px solid transparent;
            border-radius: 4px;
            background: transparent;
            transition: all 0.2s;
        }
        
        .question-text-input:focus {
            background: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }
        
        /* Question Actions */
        .question-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .question-card:hover .question-actions {
            opacity: 1;
        }
        
        .question-action {
            padding: 6px;
            color: #6b7280;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .question-action:hover {
            background: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="surveyEditor()" @keydown.window.ctrl.h="versionPanelOpen = true">
    
    <!-- Header with breadcrumb and status dropdown -->
    <header class="bg-white border-b border-gray-200 px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="#" class="text-gray-500 hover:text-gray-700">← Surveys</a>
                <span class="text-gray-400">/</span>
                <h1 class="text-xl font-medium text-gray-900">Customer Satisfaction Survey 2024</h1>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Collaboration Avatars -->
                <div class="collab-avatars">
                    <div class="collab-avatar bg-indigo-500 text-white text-xs" title="You">GP</div>
                    <div class="collab-avatar bg-purple-500 text-white text-xs" title="Sarah Chen">SC</div>
                    <div class="collab-avatar bg-green-500 text-white text-xs" title="Mike Johnson">MJ</div>
                    <div class="collab-avatar text-xs" title="2 more team members">+2</div>
                    <div class="activity-dot" title="Active now"></div>
                </div>
                
                <!-- Version Badge -->
                <div class="version-badge" @click="versionPanelOpen = true" title="View version history">
                    <span>v3</span>
                    <span class="text-xs opacity-70 ml-1">(2 hours ago)</span>
                </div>
                
                <!-- Status Dropdown -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="flex items-center space-x-1.5 px-2.5 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                        <span class="text-sm font-medium" x-text="status.charAt(0).toUpperCase() + status.slice(1)"></span>
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg border border-gray-200 py-1 z-50">
                        <button @click="status = 'draft'; open = false" class="w-full text-left px-4 py-2 text-base hover:bg-gray-100 flex items-center">
                            <span x-show="status === 'draft'" class="mr-2">✓</span>
                            <span x-show="status !== 'draft'" class="mr-2 opacity-0">✓</span>
                            Draft
                        </button>
                        <button @click="status = 'published'; open = false" class="w-full text-left px-4 py-2 text-base hover:bg-gray-100 flex items-center">
                            <span x-show="status === 'published'" class="mr-2">✓</span>
                            <span x-show="status !== 'published'" class="mr-2 opacity-0">✓</span>
                            Published
                        </button>
                        <button @click="status = 'archived'; open = false" class="w-full text-left px-4 py-2 text-base hover:bg-gray-100 flex items-center">
                            <span x-show="status === 'archived'" class="mr-2">✓</span>
                            <span x-show="status !== 'archived'" class="mr-2 opacity-0">✓</span>
                            Archived
                        </button>
                    </div>
                </div>
                <!-- Save Indicator -->
                <div class="save-indicator text-sm text-gray-500" x-show="saveStatus">
                    <span x-show="saveStatus === 'saving'">Saving...</span>
                    <span x-show="saveStatus === 'saved'" class="text-green-600">Saved ✓</span>
                    <span x-show="saveStatus === 'error'" class="text-red-600">Error ✗</span>
                </div>
                
                <!-- Keyboard Shortcuts Help -->
                <button class="text-gray-500 hover:text-gray-700" title="Keyboard shortcuts">
                    <span class="kbd">?</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-white border-b border-gray-200">
        <div class="px-6">
            <div class="flex space-x-8">
                <button @click="activeTab = 'build'" class="py-3 px-1 border-b-2 font-medium text-base transition-colors" :class="activeTab === 'build' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200'">
                    Build
                </button>
                <button @click="activeTab = 'preview'" class="py-3 px-1 border-b-2 font-medium text-base transition-colors" :class="activeTab === 'preview' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200'">
                    Preview
                </button>
                <button @click="activeTab = 'share'" class="py-3 px-1 border-b-2 font-medium text-base transition-colors" :class="activeTab === 'share' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200'">
                    Share
                </button>
                <button class="py-3 px-1 border-b-2 font-medium text-base transition-colors border-transparent text-gray-400 cursor-not-allowed" disabled>
                    Results
                </button>
                <button class="py-3 px-1 border-b-2 font-medium text-base transition-colors border-transparent text-gray-400 cursor-not-allowed" disabled>
                    Analytics
                </button>
                <button @click="activeTab = 'settings'" class="py-3 px-1 border-b-2 font-medium text-base transition-colors" :class="activeTab === 'settings' ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200'">
                    Settings
                </button>
            </div>
        </div>
    </nav>


    <!-- Main Content Area -->
    <main class="px-6 py-8">
        
        <!-- Build Tab Content -->
        <div x-show="activeTab === 'build'" 
             class="max-w-4xl mx-auto relative">
            
            <!-- Survey Title and Description (Improved inline editing) -->
            <div class="mb-8">
                <input type="text" 
                       value="Customer Satisfaction Survey"
                       class="text-3xl font-bold text-gray-900 mb-2 w-full bg-transparent border-0 focus:bg-gray-50 px-2 -mx-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       @input="debouncedAutosave">
                <input type="text"
                       value="Help us improve your dining experience by sharing your feedback"
                       class="text-gray-600 w-full bg-transparent border-0 focus:bg-gray-50 px-2 -mx-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       @input="debouncedAutosave">
            </div>

            <!-- Blocks Container -->
            <div class="space-y-4">
                <!-- Question Blocks -->
                <template x-for="(question, index) in questions" :key="question.id">
                    <div class="block group relative bg-white rounded-lg border border-gray-200 hover:shadow-sm transition-all"
                         :class="selectedQuestion === question.id ? 'ring-2 ring-indigo-500 shadow-sm' : ''">
                        
                        <!-- Drag Handle -->
                        <div class="block-handle absolute -left-8 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="text-gray-400 hover:text-gray-600 cursor-move p-1 hover:bg-gray-100 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Comment Indicator -->
                        <div class="comment-indicator"
                             :class="{ 
                                 'has-comments': getCommentCount(question.id) > 0
                             }"
                             @click="toggleCommentThread(question.id)">
                            <div class="comment-bubble"
                                 :class="{ 
                                     'has-comments': getCommentCount(question.id) > 0,
                                     'has-unresolved': hasUnresolvedComments(question.id)
                                 }">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                    </path>
                                </svg>
                                <span x-show="getCommentCount(question.id) > 0" 
                                      class="comment-count" 
                                      x-text="getCommentCount(question.id)"></span>
                            </div>
                        </div>
                        
                        <!-- Comment thread moved to sidebar -->
                        
                        <!-- Question Content -->
                        <div class="p-6" @click="selectQuestion(question.id)">
                            <!-- Question Type Badge and Question Number Container -->
                            <div class="flex items-center gap-3 mb-4">
                                <!-- Question Type Badge and Dropdown Container -->
                                <div class="relative inline-block">
                                        <button @click.stop="showQuestionTypes = showQuestionTypes === question.id ? null : question.id"
                                                @keydown.escape="showQuestionTypes = null"
                                                @keydown="handleDropdownKeydown($event, question.id)"
                                                class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full transition-all"
                                                :class="showQuestionTypes === question.id ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'">
                                            <span x-text="question.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                        
                                        <!-- Ultra-thin Question Type Dropdown -->
                                        <div x-show="showQuestionTypes === question.id" 
                                             x-transition:enter="transition ease-out duration-200"
                                             x-transition:enter-start="opacity-0 scale-95"
                                             x-transition:enter-end="opacity-100 scale-100"
                                             @click.away="showQuestionTypes = null"
                                             @keydown.escape="showQuestionTypes = null"
                                             class="question-type-dropdown">
                                            
                                            <!-- Removed search hints -->
                                            
                                            <div class="question-type-dropdown-content">
                                                <!-- Recently Used (if available) -->
                                                <div x-show="recentlyUsedTypes.length > 0" class="question-type-section">
                                                    <template x-for="type in recentlyUsedTypes" :key="'recent-' + type.id">
                                                        <button class="question-type-item"
                                                                :class="{ 'highlighted': isTypeHighlighted('recent-' + type.id) }"
                                                                @click="changeQuestionType(question.id, type.id)"
                                                                @mouseenter="setHighlightedType('recent-' + type.id)">
                                                            <span class="question-type-item-icon" x-text="type.icon"></span>
                                                            <span class="question-type-item-name" x-text="type.name"></span>
                                                            <span class="question-type-star">★</span>
                                                        </button>
                                                    </template>
                                                </div>
                                                
                                                <!-- Main question types -->
                                                <template x-for="(category, categoryName) in getQuestionTypeCategories()" :key="categoryName">
                                                    <div x-show="category.length > 0" class="question-type-section">
                                                        <div class="question-type-section-title" x-text="categoryName.charAt(0).toUpperCase() + categoryName.slice(1)"></div>
                                                        <template x-for="type in category" :key="type.id">
                                                            <button class="question-type-item"
                                                                    :class="{ 'highlighted': isTypeHighlighted(categoryName + '-' + type.id) }"
                                                                    @click="changeQuestionType(question.id, type.id)"
                                                                    @mouseenter="setHighlightedType(categoryName + '-' + type.id)">
                                                                <span class="question-type-item-icon" x-text="type.icon"></span>
                                                                <span class="question-type-item-name" x-text="type.name"></span>
                                                            </button>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Question Number - Uses remaining width -->
                                    <input type="text" 
                                           x-model="question.questionNumber"
                                           @click.stop
                                           @input="validateQuestionNumber(question.id); debouncedAutosave()"
                                           @blur="validateQuestionNumber(question.id)"
                                           class="flex-1 text-base font-medium text-gray-500 bg-transparent border-0 focus:bg-gray-50 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                           :class="{'text-red-500': !isQuestionNumberValid(question.id)}"
                                           placeholder="Q1, A1, 1.1, etc."
                                           title="Question number for research purposes">
                            </div>
                            
                            <!-- Question Text -->
                            <input type="text" 
                                   x-model="question.text"
                                   @click.stop
                                   @input="debouncedAutosave"
                                   class="text-lg font-medium text-gray-900 mb-4 w-full bg-transparent border-0 focus:bg-gray-50 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Type your question here...">
                            
                            <!-- Multiple Choice Options -->
                            <div x-show="question.type === 'multiple_choice'" class="space-y-2">
                                <template x-for="(option, optionIndex) in question.options" :key="option.id">
                                    <div class="question-option">
                                        <!-- Option Drag Handle -->
                                        <div class="option-drag-handle">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- Radio/Checkbox -->
                                        <input :type="question.settings.allowMultiple ? 'checkbox' : 'radio'" 
                                               :name="question.id" 
                                               class="text-indigo-600" 
                                               disabled>
                                        
                                        <!-- Option Text -->
                                        <input type="text" 
                                               x-model="option.text"
                                               @click.stop
                                               @input="debouncedAutosave"
                                               @keydown.enter="addOption(question.id)"
                                               @keydown.backspace="option.text === '' && removeOption(question.id, option.id)"
                                               :data-option-id="option.id"
                                               class="flex-1 px-3 py-1.5 bg-white border-0 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all duration-200"
                                               placeholder="Option text...">
                                        
                                        <!-- Remove Option Button -->
                                        <button @click.stop="removeOption(question.id, option.id)"
                                                x-show="question.options.length > 2"
                                                class="option-remove">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                                
                                <!-- Add Option Button -->
                                <button @click.stop="addOption(question.id)"
                                        class="add-option-button">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span>Add option</span>
                                </button>
                            </div>
                            
                            <!-- Text Input -->
                            <div x-show="question.type === 'text_input'">
                                <textarea placeholder="Respondent will type their answer here..." 
                                          class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 cursor-not-allowed"
                                          rows="4" 
                                          disabled></textarea>
                            </div>
                            
                            <!-- Long Text -->
                            <div x-show="question.type === 'long_text'">
                                <textarea placeholder="Respondent will type their detailed answer here..." 
                                          class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 cursor-not-allowed"
                                          rows="8" 
                                          disabled></textarea>
                                <div class="mt-2 text-sm text-gray-500 text-right">
                                    <span>0</span> / <span x-text="question.settings?.maxLength || 500"></span> characters
                                </div>
                            </div>
                            
                            <!-- Checkbox List -->
                            <div x-show="question.type === 'checkbox'" class="space-y-2">
                                <template x-for="(option, optionIndex) in question.options" :key="option.id">
                                    <div class="question-option">
                                        <div class="option-drag-handle">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                            </svg>
                                        </div>
                                        <input type="checkbox" 
                                               :name="question.id" 
                                               class="text-indigo-600 rounded" 
                                               disabled>
                                        <input type="text" 
                                               x-model="option.text"
                                               @click.stop
                                               @input="debouncedAutosave"
                                               @keydown.enter="addOption(question.id)"
                                               @keydown.backspace="option.text === '' && removeOption(question.id, option.id)"
                                               :data-option-id="option.id"
                                               class="flex-1 px-3 py-1.5 bg-white border-0 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all duration-200"
                                               placeholder="Option text...">
                                        <button @click.stop="removeOption(question.id, option.id)"
                                                x-show="question.options.length > 2"
                                                class="option-remove">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                                <button @click.stop="addOption(question.id)"
                                        class="add-option-button">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span>Add option</span>
                                </button>
                            </div>
                            
                            <!-- Yes/No -->
                            <div x-show="question.type === 'yes_no'" class="flex gap-3">
                                <button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex-1">
                                    <svg class="w-5 h-5 mx-auto mb-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Yes</span>
                                </button>
                                <button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex-1">
                                    <svg class="w-5 h-5 mx-auto mb-1 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    <span class="text-sm font-medium">No</span>
                                </button>
                            </div>
                            
                            <!-- Dropdown -->
                            <div x-show="question.type === 'dropdown'">
                                <select class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed" disabled>
                                    <option>Select an option...</option>
                                    <template x-for="option in question.options" :key="option.id">
                                        <option x-text="option.text"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <!-- Star Rating -->
                            <div x-show="question.type === 'star_rating'" class="flex gap-2">
                                <template x-for="i in 5">
                                    <button class="text-3xl text-gray-300 hover:text-yellow-400 transition-colors">★</button>
                                </template>
                            </div>
                            
                            <!-- Number Scale -->
                            <div x-show="question.type === 'number_scale'" class="flex gap-2">
                                <template x-for="i in (question.settings?.maxValue || 10)">
                                    <button class="w-10 h-10 rounded-lg bg-gray-100 hover:bg-indigo-100 hover:text-indigo-600 transition-colors font-medium text-sm"
                                            x-text="i"></button>
                                </template>
                            </div>
                            
                            <!-- NPS Score -->
                            <div x-show="question.type === 'nps'">
                                <div class="flex gap-1">
                                    <template x-for="i in 11">
                                        <button class="w-10 h-10 rounded border border-gray-200 hover:border-indigo-500 transition-colors font-medium text-sm"
                                                :class="{
                                                    'bg-red-50 text-red-600 border-red-200': i-1 <= 6,
                                                    'bg-yellow-50 text-yellow-600 border-yellow-200': i-1 >= 7 && i-1 <= 8,
                                                    'bg-green-50 text-green-600 border-green-200': i-1 >= 9
                                                }"
                                                x-text="i-1"></button>
                                    </template>
                                </div>
                                <div class="flex justify-between mt-2 text-xs text-gray-500">
                                    <span>Not likely</span>
                                    <span>Very likely</span>
                                </div>
                            </div>
                            
                            <!-- Likert Scale -->
                            <div x-show="question.type === 'likert'" class="space-y-2">
                                <div class="flex gap-2 justify-between">
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Strongly Disagree</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Disagree</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Neutral</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Agree</button>
                                    <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex-1">Strongly Agree</button>
                                </div>
                            </div>
                            
                            <!-- Slider -->
                            <div x-show="question.type === 'slider'" class="relative pt-6">
                                <input type="range" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                       :min="question.settings?.minValue || 0" 
                                       :max="question.settings?.maxValue || 100" 
                                       value="50"
                                       disabled>
                                <div class="flex justify-between text-sm text-gray-500 mt-2">
                                    <span x-text="question.settings?.minValue || 0"></span>
                                    <span class="text-indigo-600 font-medium">50</span>
                                    <span x-text="question.settings?.maxValue || 100"></span>
                                </div>
                            </div>
                            
                            <!-- Emoji Scale -->
                            <div x-show="question.type === 'emoji_scale'" class="flex gap-3 justify-center text-4xl">
                                <button class="hover:scale-110 transition-transform">😢</button>
                                <button class="hover:scale-110 transition-transform">😟</button>
                                <button class="hover:scale-110 transition-transform">😐</button>
                                <button class="hover:scale-110 transition-transform">🙂</button>
                                <button class="hover:scale-110 transition-transform">😊</button>
                            </div>
                            
                            <!-- Number Input -->
                            <div x-show="question.type === 'number'">
                                <input type="number" 
                                       placeholder="Enter a number..." 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Email Input -->
                            <div x-show="question.type === 'email'">
                                <input type="email" 
                                       placeholder="email@example.com" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Phone Input -->
                            <div x-show="question.type === 'phone'">
                                <input type="tel" 
                                       placeholder="+1 (555) 000-0000" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- URL Input -->
                            <div x-show="question.type === 'url'">
                                <input type="url" 
                                       placeholder="https://example.com" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Date Input -->
                            <div x-show="question.type === 'date'">
                                <input type="date" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Time Input -->
                            <div x-show="question.type === 'time'">
                                <input type="time" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg cursor-not-allowed"
                                       disabled>
                            </div>
                            
                            <!-- Matrix Table -->
                            <div x-show="question.type === 'matrix'" class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="text-left p-2"></th>
                                            <th class="text-center p-2 text-sm font-normal text-gray-600">Column 1</th>
                                            <th class="text-center p-2 text-sm font-normal text-gray-600">Column 2</th>
                                            <th class="text-center p-2 text-sm font-normal text-gray-600">Column 3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-t border-gray-100">
                                            <td class="p-2 text-sm">Row 1</td>
                                            <td class="text-center p-2"><input type="radio" name="row1" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row1" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row1" disabled></td>
                                        </tr>
                                        <tr class="border-t border-gray-100">
                                            <td class="p-2 text-sm">Row 2</td>
                                            <td class="text-center p-2"><input type="radio" name="row2" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row2" disabled></td>
                                            <td class="text-center p-2"><input type="radio" name="row2" disabled></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Ranking -->
                            <div x-show="question.type === 'ranking'" class="space-y-2">
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <span class="text-gray-400 cursor-move">⋮⋮</span>
                                    <span class="font-medium text-gray-500">1.</span>
                                    <span>First item to rank</span>
                                </div>
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <span class="text-gray-400 cursor-move">⋮⋮</span>
                                    <span class="font-medium text-gray-500">2.</span>
                                    <span>Second item to rank</span>
                                </div>
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <span class="text-gray-400 cursor-move">⋮⋮</span>
                                    <span class="font-medium text-gray-500">3.</span>
                                    <span>Third item to rank</span>
                                </div>
                            </div>
                            
                            <!-- Constant Sum -->
                            <div x-show="question.type === 'constant_sum'" class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <input type="number" value="0" min="0" max="100" class="w-20 px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-center" disabled>
                                    <span class="flex-1">Option 1</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="number" value="0" min="0" max="100" class="w-20 px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-center" disabled>
                                    <span class="flex-1">Option 2</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="number" value="0" min="0" max="100" class="w-20 px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-center" disabled>
                                    <span class="flex-1">Option 3</span>
                                </div>
                                <div class="text-right mt-2 p-3 bg-gray-50 rounded-lg">
                                    <span class="text-sm text-gray-600">Total: </span>
                                    <span class="font-medium">0 / 100</span>
                                </div>
                            </div>
                            
                            <!-- File Upload -->
                            <div x-show="question.type === 'file_upload'">
                                <div class="border-2 border-dashed border-gray-200 rounded-lg p-8 text-center hover:border-gray-300 transition-colors">
                                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-gray-600 mb-2">Drop files here or click to upload</p>
                                    <p class="text-sm text-gray-500">PDF, DOC, DOCX, JPG, PNG up to 10MB</p>
                                </div>
                            </div>
                            
                            <!-- Image Choice -->
                            <div x-show="question.type === 'image_choice'" class="grid grid-cols-3 gap-3">
                                <button class="relative group overflow-hidden rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition-colors">
                                    <div class="aspect-square bg-gray-100 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="p-2 text-sm text-center">Option 1</div>
                                </button>
                                <button class="relative group overflow-hidden rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition-colors">
                                    <div class="aspect-square bg-gray-100 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="p-2 text-sm text-center">Option 2</div>
                                </button>
                                <button class="relative group overflow-hidden rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition-colors">
                                    <div class="aspect-square bg-gray-100 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="p-2 text-sm text-center">Option 3</div>
                                </button>
                            </div>
                            
                            <!-- Signature -->
                            <div x-show="question.type === 'signature'">
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="h-32 border-b-2 border-gray-300 relative">
                                        <div class="absolute bottom-0 left-0 text-xs text-gray-400">Sign here</div>
                                    </div>
                                    <div class="mt-3 flex justify-end">
                                        <button class="text-sm text-gray-500 hover:text-gray-700">Clear signature</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Heat Map -->
                            <div x-show="question.type === 'heat_map'">
                                <div class="relative bg-gray-100 rounded-lg overflow-hidden">
                                    <div class="aspect-video flex items-center justify-center">
                                        <div class="text-center">
                                            <svg class="w-16 h-16 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            <p class="text-gray-500">Click anywhere on the image</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Sort -->
                            <div x-show="question.type === 'card_sort'" class="space-y-4">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Items to sort:</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <div class="px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-move">Item 1</div>
                                        <div class="px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-move">Item 2</div>
                                        <div class="px-3 py-2 bg-white rounded-lg border border-gray-200 cursor-move">Item 3</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="p-4 border-2 border-dashed border-gray-200 rounded-lg min-h-[100px]">
                                        <h4 class="text-sm font-medium text-gray-500 mb-2">Category A</h4>
                                    </div>
                                    <div class="p-4 border-2 border-dashed border-gray-200 rounded-lg min-h-[100px]">
                                        <h4 class="text-sm font-medium text-gray-500 mb-2">Category B</h4>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Question Actions -->
                            <div class="mt-4 flex items-center space-x-4 text-sm text-gray-600">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <span class="toggle-switch toggle-switch-sm">
                                        <input type="checkbox" 
                                               x-model="question.required"
                                               @change="debouncedAutosave">
                                        <span class="toggle-slider"></span>
                                    </span>
                                    <span>Required</span>
                                </label>
                                <button class="hover:text-gray-700 transition-colors">Add Logic</button>
                                <button class="hover:text-gray-700 transition-colors">Duplicate</button>
                                <button @click.stop="selectQuestion(question.id)"
                                        class="hover:text-gray-700 transition-colors flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span>Settings</span>
                                </button>
                            </div>
                        </div>
                        </div>
                    </div>
                </template>

                <!-- Add Block Button -->
                <div class="flex items-center justify-center py-8">
                    <div class="relative inline-block">
                        <button @click="showAddQuestionDropdown = !showAddQuestionDropdown; $refs.addQuestionButton = $el"
                                x-ref="addQuestionButton"
                                class="flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl">+</span>
                            <span>Add Question</span>
                        </button>
                        
                        <!-- Add Question Type Dropdown -->
                        <div x-show="showAddQuestionDropdown" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 scale-95"
                             x-transition:enter-end="opacity-100 scale-100"
                             @click.away="showAddQuestionDropdown = false"
                             @keydown.escape="showAddQuestionDropdown = false"
                             :class="{ 'bottom-full mb-2': shouldOpenUpward() }"
                             class="absolute left-1/2 transform -translate-x-1/2 mt-2 w-80 max-h-[500px] bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden z-50">
                            
                            <div class="max-h-[500px] overflow-y-auto">
                                <!-- Recently Used (if available) -->
                                <div x-show="recentlyUsedTypes && recentlyUsedTypes.length > 0" class="border-b border-gray-100">
                                    <div class="px-3 py-2 text-xs font-medium text-gray-500 uppercase">Recently Used</div>
                                    <template x-for="type in recentlyUsedTypes" :key="'add-recent-' + type.id">
                                        <button @click="addNewQuestion(type.id)"
                                                class="w-full px-4 py-2.5 text-left hover:bg-gray-50 flex items-center space-x-3 transition-colors">
                                            <span class="text-2xl" x-text="type.icon"></span>
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900" x-text="type.name"></div>
                                            </div>
                                            <span class="text-yellow-500">★</span>
                                        </button>
                                    </template>
                                </div>
                                
                                <!-- Main question types by category -->
                                <template x-for="(category, categoryName) in questionTypeCategories" :key="'add-cat-' + categoryName">
                                    <div class="border-b border-gray-100 last:border-b-0">
                                        <div class="px-3 py-2 text-xs font-medium text-gray-500 uppercase" 
                                             x-text="categoryName.charAt(0).toUpperCase() + categoryName.slice(1)"></div>
                                        <template x-for="type in category" :key="'add-type-' + type.id">
                                            <button @click="addNewQuestion(type.id)"
                                                    class="w-full px-4 py-2.5 text-left hover:bg-gray-50 flex items-center space-x-3 transition-colors">
                                                <span class="text-2xl" x-text="type.icon"></span>
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900" x-text="type.name"></div>
                                                </div>
                                            </button>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contextual Settings Panel -->
            <div x-show="showSettings && selectedQuestion" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-full"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 @click.away="showSettings = false; selectedQuestion = null"
                 class="settings-panel" :class="{ 'show': showSettings && selectedQuestion }"
                 x-data="{ activeSettingsTab: 'general' }">
                
                <template x-if="selectedQuestion">
                    <div class="h-full flex flex-col">
                        <!-- Settings Header -->
                        <div class="settings-header">
                            <h3 class="text-lg font-semibold text-gray-900">Question Settings</h3>
                            <button @click="showSettings = false; selectedQuestion = null" 
                                    class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div class="settings-tabs">
                            <button @click="activeSettingsTab = 'general'" 
                                    :class="activeSettingsTab === 'general' ? 'active' : ''"
                                    class="settings-tab">
                                General
                            </button>
                            <button @click="activeSettingsTab = 'validation'" 
                                    :class="activeSettingsTab === 'validation' ? 'active' : ''"
                                    class="settings-tab">
                                Validation
                            </button>
                            <button @click="activeSettingsTab = 'display'" 
                                    :class="activeSettingsTab === 'display' ? 'active' : ''"
                                    class="settings-tab">
                                Display
                            </button>
                            <button @click="activeSettingsTab = 'logic'" 
                                    :class="activeSettingsTab === 'logic' ? 'active' : ''"
                                    class="settings-tab"
                                    x-show="['multiple_choice', 'dropdown', 'rating_scale'].includes(getSelectedQuestion().type)">
                                Logic
                            </button>
                        </div>
                        
                        <!-- Settings Content -->
                        <div class="settings-content">
                            <!-- General Tab -->
                            <div x-show="activeSettingsTab === 'general'" class="space-y-6">
                                <!-- Question Type -->
                                <div class="settings-section">
                                    <h4 class="settings-section-title">Type</h4>
                                    <select x-model="getSelectedQuestion().type" 
                                            @change="debouncedAutosave"
                                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-base">
                                        <option value="multiple_choice">Multiple Choice</option>
                                        <option value="text_input">Text Input</option>
                                        <option value="rating_scale">Rating Scale</option>
                                        <option value="matrix">Matrix</option>
                                        <option value="dropdown">Dropdown</option>
                                        <option value="yes_no">Yes/No</option>
                                        <option value="slider">Slider</option>
                                        <option value="ranking">Ranking</option>
                                        <option value="date_time">Date/Time</option>
                                        <option value="file_upload">File Upload</option>
                                    </select>
                                </div>
                                
                                <!-- Question Text -->
                                <div class="settings-section">
                                    <h4 class="settings-section-title">Question Text</h4>
                                    <textarea x-model="getSelectedQuestion().text" 
                                              @input="debouncedAutosave"
                                              rows="3"
                                              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none text-base"
                                              placeholder="Enter your question..."></textarea>
                                </div>
                                
                                <!-- Required Toggle -->
                                <div class="settings-section">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-base font-medium text-gray-900">Required Question</h4>
                                            <p class="text-sm text-gray-500 mt-1">Respondents must answer this question</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" 
                                                   x-model="getSelectedQuestion().required"
                                                   @change="debouncedAutosave">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Validation Tab -->
                            <div x-show="activeSettingsTab === 'validation'" class="space-y-6">
                                <!-- Multiple Choice Validation -->
                                <div x-show="getSelectedQuestion().type === 'multiple_choice'" class="space-y-6">
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Selection Rules</h4>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Min selections</label>
                                                <input type="number" 
                                                       x-model="getSelectedQuestion().validation.minSelections"
                                                       @input="debouncedAutosave"
                                                       min="0" 
                                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Max selections</label>
                                                <input type="number" 
                                                       x-model="getSelectedQuestion().validation.maxSelections"
                                                       @input="debouncedAutosave"
                                                       min="0" 
                                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Text Input Validation -->
                                <div x-show="getSelectedQuestion().type === 'text_input'" class="space-y-6">
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Text Validation</h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Character Limit</label>
                                                <input type="number" 
                                                       x-model="getSelectedQuestion().validation.maxLength"
                                                       @input="debouncedAutosave"
                                                       min="0" 
                                                       placeholder="No limit"
                                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Pattern (Regex)</label>
                                                <input type="text" 
                                                       x-model="getSelectedQuestion().validation.pattern"
                                                       @input="debouncedAutosave"
                                                       placeholder="e.g. ^[A-Z]{2}[0-9]{4}$"
                                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Error Messages -->
                                <div class="settings-section">
                                    <h4 class="settings-section-title">Error Messages</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Required Field Error</label>
                                            <input type="text" 
                                                   x-model="getSelectedQuestion().validation.requiredError"
                                                   @input="debouncedAutosave"
                                                   placeholder="This field is required"
                                                   class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                                        </div>
                                        <div x-show="getSelectedQuestion().validation.pattern">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Pattern Error</label>
                                            <input type="text" 
                                                   x-model="getSelectedQuestion().validation.patternError"
                                                   @input="debouncedAutosave"
                                                   placeholder="Please enter a valid format"
                                                   class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Display Tab -->
                            <div x-show="activeSettingsTab === 'display'" class="space-y-6">
                                <!-- Multiple Choice Display -->
                                <div x-show="getSelectedQuestion().type === 'multiple_choice'" class="space-y-6">
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Display Options</h4>
                                        
                                        <!-- Allow Multiple Toggle -->
                                        <div class="flex items-center justify-between mb-4">
                                            <div>
                                                <h4 class="text-base font-medium text-gray-900">Multiple Selection</h4>
                                                <p class="text-sm text-gray-500 mt-1">Allow selecting multiple options</p>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" 
                                                       x-model="getSelectedQuestion().settings.allowMultiple"
                                                       @change="debouncedAutosave">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        
                                        <!-- Randomize Toggle -->
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h4 class="text-base font-medium text-gray-900">Randomize Options</h4>
                                                <p class="text-sm text-gray-500 mt-1">Show options in random order</p>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" 
                                                       x-model="getSelectedQuestion().settings.randomizeOptions"
                                                       @change="debouncedAutosave">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Display Format</h4>
                                        <div class="display-format-grid">
                                            <!-- List Format -->
                                            <label class="display-format-card" 
                                                   :class="{ 'selected': getSelectedQuestion().settings.displayFormat === 'list' }">
                                                <input type="radio" 
                                                       name="displayFormat" 
                                                       value="list"
                                                       x-model="getSelectedQuestion().settings.displayFormat"
                                                       @change="debouncedAutosave">
                                                <div class="display-format-icon">
                                                    <svg class="w-full h-full text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                                    </svg>
                                                </div>
                                                <div class="display-format-label">List</div>
                                            </label>
                                            
                                            <!-- Grid Format -->
                                            <label class="display-format-card" 
                                                   :class="{ 'selected': getSelectedQuestion().settings.displayFormat === 'grid' }">
                                                <input type="radio" 
                                                       name="displayFormat" 
                                                       value="grid"
                                                       x-model="getSelectedQuestion().settings.displayFormat"
                                                       @change="debouncedAutosave">
                                                <div class="display-format-icon">
                                                    <svg class="w-full h-full text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                                                    </svg>
                                                </div>
                                                <div class="display-format-label">Grid</div>
                                            </label>
                                            
                                            <!-- Dropdown Format -->
                                            <label class="display-format-card" 
                                                   :class="{ 'selected': getSelectedQuestion().settings.displayFormat === 'dropdown' }">
                                                <input type="radio" 
                                                       name="displayFormat" 
                                                       value="dropdown"
                                                       x-model="getSelectedQuestion().settings.displayFormat"
                                                       @change="debouncedAutosave">
                                                <div class="display-format-icon">
                                                    <svg class="w-full h-full text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div class="display-format-label">Dropdown</div>
                                            </label>
                                            
                                            <!-- Button Format -->
                                            <label class="display-format-card" 
                                                   :class="{ 'selected': getSelectedQuestion().settings.displayFormat === 'buttons' }">
                                                <input type="radio" 
                                                       name="displayFormat" 
                                                       value="buttons"
                                                       x-model="getSelectedQuestion().settings.displayFormat"
                                                       @change="debouncedAutosave">
                                                <div class="display-format-icon">
                                                    <svg class="w-full h-full text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                                                    </svg>
                                                </div>
                                                <div class="display-format-label">Buttons</div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            
                                <!-- Text Input Display -->
                                <div x-show="getSelectedQuestion().type === 'text_input'" class="space-y-6">
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Input Type</h4>
                                        <select x-model="getSelectedQuestion().settings.inputType" 
                                                @change="debouncedAutosave"
                                                class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            <option value="text">Single line</option>
                                            <option value="textarea">Multi-line</option>
                                            <option value="email">Email</option>
                                            <option value="number">Number</option>
                                            <option value="url">URL</option>
                                            <option value="tel">Phone</option>
                                        </select>
                                    </div>
                                    
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Placeholder</h4>
                                        <input type="text" 
                                               x-model="getSelectedQuestion().settings.placeholder"
                                               @input="debouncedAutosave"
                                               placeholder="Enter placeholder text..."
                                               class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    </div>
                                    
                                    <div class="settings-section" x-show="getSelectedQuestion().settings.inputType === 'textarea'">
                                        <h4 class="settings-section-title">Text Area Rows</h4>
                                        <input type="number" 
                                               x-model="getSelectedQuestion().settings.rows"
                                               @input="debouncedAutosave"
                                               min="2"
                                               max="10"
                                               placeholder="4"
                                               class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    </div>
                                </div>
                                
                                <!-- Rating Scale Display -->
                                <div x-show="getSelectedQuestion().type === 'rating_scale'" class="space-y-6">
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Scale Type</h4>
                                        <div class="display-format-grid">
                                            <!-- Stars -->
                                            <label class="display-format-card" 
                                                   :class="{ 'selected': getSelectedQuestion().settings.scaleType === 'stars' }">
                                                <input type="radio" 
                                                       value="stars"
                                                       x-model="getSelectedQuestion().settings.scaleType"
                                                       @change="debouncedAutosave">
                                                <div class="display-format-icon">
                                                    <span class="text-2xl">⭐</span>
                                                </div>
                                                <div class="display-format-label">Stars</div>
                                            </label>
                                            
                                            <!-- Numbers -->
                                            <label class="display-format-card" 
                                                   :class="{ 'selected': getSelectedQuestion().settings.scaleType === 'numbers' }">
                                                <input type="radio" 
                                                       value="numbers"
                                                       x-model="getSelectedQuestion().settings.scaleType"
                                                       @change="debouncedAutosave">
                                                <div class="display-format-icon">
                                                    <span class="text-2xl font-bold text-gray-600">1-5</span>
                                                </div>
                                                <div class="display-format-label">Numbers</div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="settings-section">
                                        <h4 class="settings-section-title">Scale Range</h4>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Min Value</label>
                                                <input type="number" 
                                                       x-model="getSelectedQuestion().settings.minValue"
                                                       @input="debouncedAutosave"
                                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Max Value</label>
                                                <input type="number" 
                                                       x-model="getSelectedQuestion().settings.maxValue"
                                                       @input="debouncedAutosave"
                                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Logic Tab -->
                            <div x-show="activeSettingsTab === 'logic'" class="space-y-6">
                                <div class="settings-section">
                                    <h4 class="settings-section-title">Conditional Logic</h4>
                                    <p class="text-sm text-gray-500 mb-4">Show or hide questions based on responses</p>
                                    
                                    <button class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors text-sm font-medium text-gray-700">
                                        + Add Logic Rule
                                    </button>
                                </div>
                                
                                <div class="settings-section">
                                    <h4 class="settings-section-title">Skip Logic</h4>
                                    <p class="text-sm text-gray-500 mb-4">Jump to specific questions based on answers</p>
                                    
                                    <button class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors text-sm font-medium text-gray-700">
                                        + Add Skip Rule
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Delete Question - Always visible at bottom -->
                            <div class="pt-6 mt-6 border-t border-gray-200">
                                <button @click="deleteQuestion(selectedQuestion)"
                                        class="w-full px-4 py-2.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors font-medium">
                                    Delete Question
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
                
                <!-- Slash Menu (shown when / is typed) -->
                <div x-show="showSlashMenu" @click.away="showSlashMenu = false" class="slash-menu fixed bg-white rounded-lg border border-gray-200 p-2 w-64 z-50" style="top: 500px; left: 50%; transform: translateX(-50%);">
                    <div class="text-xs font-medium text-gray-500 uppercase px-3 py-2">Basic Blocks</div>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>📝</span>
                        <div>
                            <div class="font-medium">Text</div>
                            <div class="text-base text-gray-500">Short answer question</div>
                        </div>
                    </button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>🔘</span>
                        <div>
                            <div class="font-medium">Multiple Choice</div>
                            <div class="text-base text-gray-500">Single or multiple selection</div>
                        </div>
                    </button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>⭐</span>
                        <div>
                            <div class="font-medium">Rating</div>
                            <div class="text-base text-gray-500">Star rating or NPS</div>
                        </div>
                    </button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>📊</span>
                        <div>
                            <div class="font-medium">Matrix</div>
                            <div class="text-base text-gray-500">Grid questions</div>
                        </div>
                    </button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>📅</span>
                        <div>
                            <div class="font-medium">Date/Time</div>
                            <div class="text-base text-gray-500">Calendar picker</div>
                        </div>
                    </button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>📏</span>
                        <div>
                            <div class="font-medium">Slider</div>
                            <div class="text-base text-gray-500">Numeric scale</div>
                        </div>
                    </button>
                    <div class="border-t border-gray-200 my-2"></div>
                    <div class="text-xs font-medium text-gray-500 uppercase px-3 py-2">Layout</div>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>📄</span>
                        <div>
                            <div class="font-medium">Page Break</div>
                            <div class="text-base text-gray-500">Split into multiple pages</div>
                        </div>
                    </button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>📑</span>
                        <div>
                            <div class="font-medium">Section</div>
                            <div class="text-base text-gray-500">Group related questions</div>
                        </div>
                    </button>
                    <div class="border-t border-gray-200 my-2"></div>
                    <div class="text-xs font-medium text-gray-500 uppercase px-3 py-2">Advanced</div>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>📋</span>
                        <div>
                            <div class="font-medium">Template</div>
                            <div class="text-base text-gray-500">Use a pre-built template</div>
                        </div>
                    </button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center space-x-3">
                        <span>🤖</span>
                        <div>
                            <div class="font-medium">AI Suggest</div>
                            <div class="text-base text-gray-500">Let AI add questions</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
            
        <!-- Comment Sidebar -->
            <div class="comment-sidebar-overlay" :class="{ 'active': commentSidebarActive }" @click="closeCommentSidebar()"></div>
            
            <div class="comment-sidebar" :class="{ 'active': commentSidebarActive }">
                <!-- Sidebar Header -->
                <div class="comment-sidebar-header">
                    <div class="comment-sidebar-title">
                        <h3>Comments</h3>
                        <button @click="closeCommentSidebar()" class="comment-sidebar-close">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <template x-if="activeCommentThread">
                        <div class="comment-question-context">
                            <div class="text-sm">Comments on question:</div>
                            <div class="comment-question-text" x-text="questions.find(q => q.id === activeCommentThread)?.text || 'Question'"></div>
                        </div>
                    </template>
                </div>
                
                <!-- Sidebar Body -->
                <div class="comment-sidebar-body">
                    <div class="comment-list">
                        <template x-for="comment in getComments(activeCommentThread)" :key="comment.id">
                            <div class="comment-item" :class="{ 'resolved': comment.resolved }">
                                <div class="comment-author">
                                    <div class="comment-avatar" x-text="comment.author.split(' ').map(n => n[0]).join('')"></div>
                                    <div class="comment-meta">
                                        <div class="comment-name" x-text="comment.author"></div>
                                        <div class="comment-role" x-text="comment.role"></div>
                                    </div>
                                    <div class="comment-time" x-text="formatCommentTime(comment.timestamp)"></div>
                                </div>
                                
                                <div class="comment-badge" :class="comment.type" x-text="getCommentTypeLabel(comment.type)"></div>
                                
                                <div class="comment-body" x-text="comment.text"></div>
                                
                                <div class="comment-actions" x-show="!comment.resolved">
                                    <button @click="resolveComment(activeCommentThread, comment.id)" class="comment-action">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Resolve
                                    </button>
                                    <button class="comment-action">Reply</button>
                                    <button @click="deleteComment(activeCommentThread, comment.id)" class="comment-action text-red-600">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="!activeCommentThread || getComments(activeCommentThread).length === 0" 
                             class="text-center py-12 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                </path>
                            </svg>
                            <p class="text-base font-medium">No comments yet</p>
                            <p class="text-sm mt-1">Start a discussion about this question</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar Footer -->
                <div class="comment-sidebar-footer">
                    <div class="comment-type-selector">
                        <template x-for="type in ['blocker', 'suggestion', 'question', 'idea', 'approval', 'reference']" :key="type">
                            <button @click="newCommentType = type"
                                    :class="{ 'selected': newCommentType === type }"
                                    class="comment-type-option"
                                    x-text="getCommentTypeLabel(type)"></button>
                        </template>
                    </div>
                    
                    <textarea x-model="newCommentText"
                              @keydown.enter.ctrl="addComment(activeCommentThread)"
                              placeholder="Add a comment..."
                              class="comment-textarea"></textarea>
                    
                    <div class="comment-submit">
                        <button @click="closeCommentSidebar()" 
                                class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors">
                            Cancel
                        </button>
                        <button @click="addComment(activeCommentThread)" 
                                :disabled="!newCommentText || !newCommentText.trim()"
                                class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            Add Comment
                        </button>
                    </div>
                </div>
            </div>

        <!-- Preview Tab Content -->
        <div x-show="activeTab === 'preview'" x-data="{ previewDevice: 'desktop' }">
            <!-- Device Selector (Subtle Segmented Control) -->
            <div class="flex justify-center mb-6">
                <div class="inline-flex bg-gray-100 rounded-lg p-1">
                    <button @click="previewDevice = 'desktop'" 
                            :class="previewDevice === 'desktop' ? 'bg-white shadow-sm' : ''"
                            class="px-3 py-1.5 text-base font-medium rounded-md transition-all">
                        Desktop
                    </button>
                    <button @click="previewDevice = 'tablet'" 
                            :class="previewDevice === 'tablet' ? 'bg-white shadow-sm' : ''"
                            class="px-3 py-1.5 text-base font-medium rounded-md transition-all">
                        Tablet
                    </button>
                    <button @click="previewDevice = 'mobile'" 
                            :class="previewDevice === 'mobile' ? 'bg-white shadow-sm' : ''"
                            class="px-3 py-1.5 text-base font-medium rounded-md transition-all">
                        Mobile
                    </button>
                </div>
            </div>
            
            <!-- Preview Container -->
            <div class="flex justify-center">
                <!-- Desktop Preview -->
                <div x-show="previewDevice === 'desktop'" x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     class="w-full max-w-3xl">
                    <div class="bg-white rounded-lg shadow-lg">
                        <!-- Survey Header -->
                        <div class="px-8 py-6 border-b border-gray-200">
                            <h1 class="text-2xl font-bold text-gray-900">Customer Satisfaction Survey</h1>
                            <p class="mt-2 text-gray-600">Help us improve your dining experience by sharing your feedback</p>
                        </div>
                        
                        <!-- Survey Content -->
                        <div class="px-8 py-6 space-y-8">
                            <!-- Question 1 -->
                            <div>
                                <div class="flex items-start space-x-3 mb-4">
                                    <span class="text-base font-medium text-gray-500">1.</span>
                                    <h3 class="text-lg font-medium text-gray-900">How satisfied were you with your overall dining experience?</h3>
                                </div>
                                <div class="ml-6 space-y-3">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="radio" name="preview-q1" class="text-indigo-600">
                                        <span>Very Satisfied</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="radio" name="preview-q1" class="text-indigo-600">
                                        <span>Satisfied</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="radio" name="preview-q1" class="text-indigo-600">
                                        <span>Neutral</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="radio" name="preview-q1" class="text-indigo-600">
                                        <span>Dissatisfied</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="radio" name="preview-q1" class="text-indigo-600">
                                        <span>Very Dissatisfied</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Question 2 -->
                            <div>
                                <div class="flex items-start space-x-3 mb-4">
                                    <span class="text-base font-medium text-gray-500">2.</span>
                                    <h3 class="text-lg font-medium text-gray-900">What could we improve about your experience?</h3>
                                </div>
                                <div class="ml-6">
                                    <textarea placeholder="Type your answer here..." 
                                              class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                                              rows="4"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Survey Footer -->
                        <div class="px-8 py-6 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                            <div class="text-base text-gray-500">
                                Page 1 of 1
                            </div>
                            <button class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tablet Preview -->
                <div x-show="previewDevice === 'tablet'" x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     class="relative">
                    <!-- iPad Frame -->
                    <div class="device-frame w-[768px] h-[1024px] bg-gray-900 rounded-[36px] p-4 shadow-2xl">
                        <div class="w-full h-full bg-white rounded-[20px] overflow-hidden">
                            <!-- Survey Content (Same as desktop but in frame) -->
                            <div class="h-full overflow-y-auto">
                                <div class="px-6 py-5 border-b border-gray-200">
                                    <h1 class="text-xl font-bold text-gray-900">Customer Satisfaction Survey</h1>
                                    <p class="mt-1 text-gray-600 text-base">Help us improve your dining experience by sharing your feedback</p>
                                </div>
                                <div class="px-6 py-5 space-y-6">
                                    <!-- Question 1 -->
                                    <div>
                                        <div class="flex items-start space-x-2 mb-3">
                                            <span class="text-base font-medium text-gray-500">1.</span>
                                            <h3 class="text-base font-medium text-gray-900">How satisfied were you with your overall dining experience?</h3>
                                        </div>
                                        <div class="ml-5 space-y-2">
                                            <label class="flex items-center space-x-3 cursor-pointer">
                                                <input type="radio" name="tablet-q1" class="text-indigo-600">
                                                <span class="text-base">Very Satisfied</span>
                                            </label>
                                            <label class="flex items-center space-x-3 cursor-pointer">
                                                <input type="radio" name="tablet-q1" class="text-indigo-600">
                                                <span class="text-base">Satisfied</span>
                                            </label>
                                            <label class="flex items-center space-x-3 cursor-pointer">
                                                <input type="radio" name="tablet-q1" class="text-indigo-600">
                                                <span class="text-base">Neutral</span>
                                            </label>
                                            <label class="flex items-center space-x-3 cursor-pointer">
                                                <input type="radio" name="tablet-q1" class="text-indigo-600">
                                                <span class="text-base">Dissatisfied</span>
                                            </label>
                                            <label class="flex items-center space-x-3 cursor-pointer">
                                                <input type="radio" name="tablet-q1" class="text-indigo-600">
                                                <span class="text-base">Very Dissatisfied</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Question 2 -->
                                    <div>
                                        <div class="flex items-start space-x-2 mb-3">
                                            <span class="text-base font-medium text-gray-500">2.</span>
                                            <h3 class="text-base font-medium text-gray-900">What could we improve about your experience?</h3>
                                        </div>
                                        <div class="ml-5">
                                            <textarea placeholder="Type your answer here..." 
                                                      class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none text-base"
                                                      rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <!-- Survey Footer -->
                                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                                    <div class="text-base text-gray-500">
                                        Page 1 of 1
                                    </div>
                                    <button class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-base">
                                        Submit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Preview -->
                <div x-show="previewDevice === 'mobile'" x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     class="relative">
                    <!-- iPhone Frame -->
                    <div class="device-frame w-[375px] h-[812px] bg-gray-900 rounded-[40px] p-3 shadow-2xl">
                        <div class="w-full h-full bg-white rounded-[30px] overflow-hidden">
                            <!-- Survey Content (Mobile optimized) -->
                            <div class="h-full overflow-y-auto">
                                <div class="px-4 py-4 border-b border-gray-200">
                                    <h1 class="text-lg font-bold text-gray-900">Customer Satisfaction Survey</h1>
                                    <p class="mt-1 text-gray-600 text-base">Help us improve your experience</p>
                                </div>
                                <div class="px-4 py-4 space-y-6">
                                    <!-- Question 1 (Mobile optimized - one question per screen) -->
                                    <div>
                                        <div class="mb-4">
                                            <span class="text-xs font-medium text-gray-500 block mb-2">Question 1 of 2</span>
                                            <h3 class="text-base font-medium text-gray-900">How satisfied were you with your overall dining experience?</h3>
                                        </div>
                                        <div class="space-y-3">
                                            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                                <input type="radio" name="mobile-q1" class="text-indigo-600 mr-3">
                                                <span>Very Satisfied</span>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                                <input type="radio" name="mobile-q1" class="text-indigo-600 mr-3">
                                                <span>Satisfied</span>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                                <input type="radio" name="mobile-q1" class="text-indigo-600 mr-3">
                                                <span>Neutral</span>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                                <input type="radio" name="mobile-q1" class="text-indigo-600 mr-3">
                                                <span>Dissatisfied</span>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                                <input type="radio" name="mobile-q1" class="text-indigo-600 mr-3">
                                                <span>Very Dissatisfied</span>
                                            </label>
                                        </div>
                                        <div class="mt-6 flex justify-between">
                                            <button class="text-gray-400" disabled>Previous</button>
                                            <button class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Next</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Tab Content -->
        <div x-show="activeTab === 'share'" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="max-w-4xl mx-auto" 
             x-data="{ copied: false, copiedEmbed: false }">
            <div class="space-y-12">
                <!-- Direct Link Section -->
                <div>
                    <h3 class="text-base font-medium text-gray-900 mb-4">Share Link</h3>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 relative">
                            <input type="text" 
                                   value="https://surveys.mindful.com/s/abc123" 
                                   readonly 
                                   class="w-full px-4 py-2.5 pr-12 bg-white border border-gray-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <button @click="navigator.clipboard.writeText('https://surveys.mindful.com/s/abc123'); copied = true; setTimeout(() => copied = false, 2000)"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-gray-600 transition-colors">
                                <svg x-show="!copied" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <svg x-show="copied" class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- QR Code & Embed Section -->
                <div class="grid grid-cols-2 gap-8">
                    <!-- QR Code -->
                    <div>
                        <h3 class="text-base font-medium text-gray-900 mb-4">QR Code</h3>
                        <div class="bg-white rounded-xl shadow-sm p-8 text-center hover:shadow-md transition-shadow">
                            <div class="bg-gray-50 h-48 w-48 mx-auto rounded-lg flex items-center justify-center">
                                <span class="text-gray-400 text-base">[QR Code]</span>
                            </div>
                            <button class="mt-6 text-base text-indigo-600 hover:text-indigo-700 font-medium">
                                Download PNG
                            </button>
                        </div>
                    </div>
                    
                    <!-- Embed Code -->
                    <div>
                        <h3 class="text-base font-medium text-gray-900 mb-4">Embed Code</h3>
                        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
                            <pre class="bg-gray-50 p-4 rounded-lg text-xs overflow-x-auto font-mono text-gray-600"><code>&lt;iframe 
  src="https://surveys.mindful.com/s/abc123"
  width="100%" 
  height="600"
  frameborder="0"&gt;
&lt;/iframe&gt;</code></pre>
                            <button @click="navigator.clipboard.writeText('<iframe src=&quot;https://surveys.mindful.com/s/abc123&quot; width=&quot;100%&quot; height=&quot;600&quot; frameborder=&quot;0&quot;></iframe>'); copiedEmbed = true; setTimeout(() => copiedEmbed = false, 2000)"
                                    class="mt-4 text-base text-indigo-600 hover:text-indigo-700 font-medium flex items-center space-x-2">
                                <span x-text="copiedEmbed ? 'Copied!' : 'Copy embed code'"></span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Team Sharing Section -->
                <div>
                    <h3 class="text-sm font-medium text-gray-900 mb-4">Team Access</h3>
                    <div class="space-y-4">
                        <!-- Invite Form -->
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <div class="flex items-center space-x-3">
                                <input type="email" 
                                       placeholder="Add people by email" 
                                       class="flex-1 px-3 py-2 bg-gray-50 border-0 rounded-lg text-base placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                                <select class="px-3 py-2 bg-gray-50 border-0 rounded-lg text-base text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option>Can edit</option>
                                    <option>Can view</option>
                                    <option>Can comment</option>
                                </select>
                                <button class="px-4 py-2 bg-indigo-600 text-white text-base rounded-lg hover:bg-indigo-700 transition-colors">
                                    Send invite
                                </button>
                            </div>
                        </div>
                        
                        <!-- Team Members -->
                        <div class="space-y-1">
                            <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center text-base font-medium">SC</div>
                                    <div>
                                        <div class="text-base font-medium text-gray-900">Sarah Chen</div>
                                        <div class="text-base text-gray-500">sarah@company.com</div>
                                    </div>
                                </div>
                                <select class="px-2 py-1 text-xs bg-transparent border border-gray-200 rounded-lg text-gray-600 hover:border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option>Can edit</option>
                                    <option>Can view</option>
                                    <option>Can comment</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-base font-medium">MJ</div>
                                    <div>
                                        <div class="text-base font-medium text-gray-900">Mike Johnson</div>
                                        <div class="text-base text-gray-500">mike@company.com</div>
                                    </div>
                                </div>
                                <select class="px-2 py-1 text-xs bg-transparent border border-gray-200 rounded-lg text-gray-600 hover:border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option>Can view</option>
                                    <option selected>Can edit</option>
                                    <option>Can comment</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-between p-3 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-indigo-500 text-white rounded-full flex items-center justify-center text-base font-medium">GP</div>
                                    <div>
                                        <div class="text-base font-medium text-gray-900">You</div>
                                        <div class="text-base text-gray-500">Owner</div>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-500">Owner</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div x-show="activeTab === 'settings'" class="max-w-5xl mx-auto px-8 py-8">
            <div class="grid grid-cols-5 gap-10">
                <!-- Settings Sidebar -->
                <div class="col-span-1">
                    <nav class="space-y-0.5">
                        <button @click="settingsSection = 'general'" 
                                class="w-full text-left px-3 py-2 rounded-md transition-colors text-base" 
                                :class="settingsSection === 'general' ? 'text-gray-900 bg-gray-100' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'">
                            General
                        </button>
                        <button @click="settingsSection = 'design'" 
                                class="w-full text-left px-3 py-2 rounded-md transition-colors text-base" 
                                :class="settingsSection === 'design' ? 'text-gray-900 bg-gray-100' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'">
                            Design
                        </button>
                        <button @click="settingsSection = 'logic'" 
                                class="w-full text-left px-3 py-2 rounded-md transition-colors text-base" 
                                :class="settingsSection === 'logic' ? 'text-gray-900 bg-gray-100' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'">
                            Logic Rules
                        </button>
                        <button @click="settingsSection = 'integrations'" 
                                class="w-full text-left px-3 py-2 rounded-md transition-colors text-base" 
                                :class="settingsSection === 'integrations' ? 'text-gray-900 bg-gray-100' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'">
                            Integrations
                        </button>
                        <button @click="settingsSection = 'versions'" 
                                class="w-full text-left px-3 py-2 rounded-md transition-colors text-base" 
                                :class="settingsSection === 'versions' ? 'text-gray-900 bg-gray-100' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'">
                            Versions
                        </button>
                        <div class="pt-4 mt-4 border-t border-gray-200">
                            <button @click="settingsSection = 'danger'" 
                                    class="w-full text-left px-3 py-2 rounded-md transition-colors text-base text-red-600 hover:bg-red-50">
                                Danger Zone
                            </button>
                        </div>
                    </nav>
                </div>
                
                <!-- Settings Content -->
                <div class="col-span-4">
                    <!-- General Settings -->
                    <div x-show="settingsSection === 'general'" x-transition>
                        <h3 class="text-lg font-medium text-gray-900 mb-6">General Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-1.5">Survey Name</label>
                                <input type="text" 
                                       value="Customer Satisfaction Survey" 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors">
                            </div>
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-1.5">Description</label>
                                <textarea class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors" 
                                          rows="3">Help us improve your dining experience</textarea>
                            </div>
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-1.5">Survey URL</label>
                                <div class="flex items-center space-x-2">
                                    <input type="text" 
                                           value="mindful-metrics.com/s/customer-satisfaction-2025" 
                                           class="flex-1 px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-600" 
                                           readonly>
                                    <button class="px-3 py-2 text-base text-gray-600 hover:text-gray-900 transition-colors">
                                        Edit
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-1.5">Language</label>
                                <select class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option>English (US)</option>
                                    <option>Spanish</option>
                                    <option>French</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Version History -->
                    <div x-show="settingsSection === 'versions'" x-transition>
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-medium text-gray-900">Version History</h3>
                            <button @click="versionPanelOpen = true" class="text-base text-indigo-600 hover:text-indigo-700">
                                View all changes →
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <p class="text-base text-gray-600">Your survey has been automatically saved <strong>3 times</strong> today with <strong>12 changes</strong> tracked.</p>
                        </div>
                        <div class="space-y-3">
                            <!-- Current Version -->
                            <div class="group bg-white border border-gray-200 rounded-lg p-4 transition-all hover:shadow-sm cursor-pointer" @click="versionPanelOpen = true; selectedVersion = 3">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-medium text-base">Version 3</span>
                                        <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs">Current</span>
                                    </div>
                                    <span class="text-base text-gray-500">2 hours ago</span>
                                </div>
                                <p class="text-base text-gray-600 mb-3">Added demographic questions block</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-base text-gray-500">
                                        <div class="w-5 h-5 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs mr-2">S</div>
                                        Sarah Chen
                                    </div>
                                    <span class="text-xs text-gray-500">4 changes</span>
                                </div>
                            </div>
                            
                            <!-- Previous Versions -->
                            <div class="group bg-white border border-gray-200 rounded-lg p-4 cursor-pointer transition-all hover:shadow-sm" @click="versionPanelOpen = true; selectedVersion = 2">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-base">Version 2</span>
                                    <span class="text-base text-gray-500">Yesterday at 3:45 PM</span>
                                </div>
                                <p class="text-base text-gray-600 mb-3">Updated satisfaction scale from 3 to 5 points</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-base text-gray-500">
                                        <div class="w-5 h-5 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs mr-2">G</div>
                                        You
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xs text-gray-500">6 changes</span>
                                        <button @click.stop="restoreVersion(2)" class="text-xs text-indigo-600 hover:text-indigo-700 opacity-0 group-hover:opacity-100 transition-opacity">
                                            Restore
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="group bg-white border border-gray-200 rounded-lg p-4 cursor-pointer transition-all hover:shadow-sm" @click="versionPanelOpen = true; selectedVersion = 1">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-base">Version 1</span>
                                    <span class="text-base text-gray-500">Jan 22, 2025</span>
                                </div>
                                <p class="text-base text-gray-600 mb-3">Initial survey creation</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-base text-gray-500">
                                        <div class="w-5 h-5 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs mr-2">G</div>
                                        You
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xs text-gray-500">2 changes</span>
                                        <button @click.stop="restoreVersion(1)" class="text-xs text-indigo-600 hover:text-indigo-700 opacity-0 group-hover:opacity-100 transition-opacity">
                                            Restore
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auto-save Settings -->
                        <div class="mt-8 pt-8 border-t border-gray-200">
                            <h4 class="text-base font-medium text-gray-900 mb-4">Version Settings</h4>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between">
                                    <span class="text-base text-gray-700">Create version on publish</span>
                                    <input type="checkbox" checked class="text-indigo-600 rounded">
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-base text-gray-700">Track detailed changes</span>
                                    <input type="checkbox" checked class="text-indigo-600 rounded">
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-base text-gray-700">Show inline diffs</span>
                                    <input type="checkbox" class="text-indigo-600 rounded">
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Design Settings -->
                    <div x-show="settingsSection === 'design'" x-transition>
                        <h3 class="text-lg font-medium text-gray-900 mb-6">Design & Branding</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-3">Theme Color</label>
                                <div class="flex items-center space-x-3">
                                    <button class="w-10 h-10 bg-indigo-600 rounded-lg ring-2 ring-offset-2 ring-indigo-600"></button>
                                    <button class="w-10 h-10 bg-purple-600 rounded-lg hover:ring-2 hover:ring-offset-2 hover:ring-purple-600 transition-all"></button>
                                    <button class="w-10 h-10 bg-blue-600 rounded-lg hover:ring-2 hover:ring-offset-2 hover:ring-blue-600 transition-all"></button>
                                    <button class="w-10 h-10 bg-green-600 rounded-lg hover:ring-2 hover:ring-offset-2 hover:ring-green-600 transition-all"></button>
                                    <button class="w-10 h-10 bg-gray-800 rounded-lg hover:ring-2 hover:ring-offset-2 hover:ring-gray-800 transition-all"></button>
                                    <div class="ml-4 text-base text-gray-500">Custom</div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-3">Logo</label>
                                <div class="flex items-center space-x-4">
                                    <div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <button class="px-4 py-2 text-base border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                                        Upload Logo
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-1.5">Font</label>
                                <select class="w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option>System Default</option>
                                    <option>Inter</option>
                                    <option>Roboto</option>
                                    <option>Open Sans</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Integrations -->
                    <div x-show="settingsSection === 'integrations'" x-transition>
                        <h3 class="text-lg font-medium text-gray-900 mb-6">Integrations</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <span class="text-lg">📊</span>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-medium">Google Analytics</h4>
                                        <p class="text-base text-gray-500">Track survey completions and drop-offs</p>
                                    </div>
                                </div>
                                <button class="px-3 py-1.5 text-base border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                                    Connect
                                </button>
                            </div>
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <span class="text-lg">💬</span>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-medium">Slack</h4>
                                        <p class="text-base text-gray-500">Get notified of new responses</p>
                                    </div>
                                </div>
                                <button class="px-3 py-1.5 text-base border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                                    Connect
                                </button>
                            </div>
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <span class="text-lg">📧</span>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-medium">Mailchimp</h4>
                                        <p class="text-base text-gray-500">Sync respondents to your lists</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1.5 text-base text-green-700 bg-green-100 rounded-md">
                                    Connected
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logic Rules -->
                    <div x-show="settingsSection === 'logic'" x-transition>
                        <h3 class="text-lg font-medium text-gray-900 mb-6">Logic Rules</h3>
                        <div class="space-y-4">
                            <p class="text-base text-gray-600">No logic rules configured yet.</p>
                            <button class="px-4 py-2 text-base text-indigo-600 border border-indigo-200 rounded-md hover:bg-indigo-50 transition-colors">
                                + Add Logic Rule
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div x-show="settingsSection === 'danger'" x-transition>
                        <h3 class="text-lg font-medium text-red-900 mb-6">Danger Zone</h3>
                        <div class="space-y-4">
                            <div class="p-5 border border-gray-200 rounded-lg">
                                <h4 class="font-medium text-gray-900 mb-2">Archive Survey</h4>
                                <p class="text-base text-gray-600 mb-4">Archive this survey and hide it from your active surveys list.</p>
                                <button class="px-4 py-2 text-base text-gray-700 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                                    Archive Survey
                                </button>
                            </div>
                            <div class="p-5 border border-red-200 rounded-lg bg-red-50">
                                <h4 class="font-medium text-gray-900 mb-2">Delete Survey</h4>
                                <p class="text-base text-gray-600 mb-4">Permanently delete this survey and all its responses. This action cannot be undone.</p>
                                <button class="px-4 py-2 text-base bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                                    Delete Survey
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
    </main>

    <!-- AI Chat Widget -->
    <div class="ai-chat-widget" x-data="{ chatOpen: false }">
        <!-- Minimized State - Chat Button -->
        <div x-show="!chatOpen" x-transition class="ai-chat-button" @click="chatOpen = true">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
        </div>
        
        <!-- Expanded State - Chat Window -->
        <div x-show="chatOpen" x-transition class="ai-chat-window">
            <!-- Chat Header -->
            <div class="ai-chat-header">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <div>
                        <h3 class="font-semibold">AI Assistant</h3>
                        <p class="text-sm opacity-90">Here to help you build better surveys</p>
                    </div>
                </div>
                <button @click="chatOpen = false" class="text-white opacity-80 hover:opacity-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Chat Body -->
            <div class="ai-chat-body">
                <!-- Welcome Message -->
                <div class="mb-4">
                    <div class="text-base text-gray-600 mb-3">Hi! I can help you:</div>
                    <div class="space-y-2">
                        <div class="ai-suggestion" @click="processAISuggestion('Create a customer satisfaction survey')">
                            <div class="font-medium text-base">Create a complete survey</div>
                            <div class="text-base text-gray-500">Tell me your goal and I'll build it</div>
                        </div>
                        <div class="ai-suggestion" @click="processAISuggestion('Add demographic questions')">
                            <div class="font-medium text-base">Add question blocks</div>
                            <div class="text-base text-gray-500">Demographics, NPS, rating scales</div>
                        </div>
                        <div class="ai-suggestion" @click="processAISuggestion('Improve my survey questions')">
                            <div class="font-medium text-base">Improve existing questions</div>
                            <div class="text-base text-gray-500">Make them clearer and unbiased</div>
                        </div>
                        <div class="ai-suggestion" @click="processAISuggestion('Add branching logic')">
                            <div class="font-medium text-base">Set up logic flows</div>
                            <div class="text-base text-gray-500">Skip logic, branching, conditions</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages Area -->
                <div id="chat-messages" class="space-y-3">
                    <!-- Messages will appear here -->
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="ai-chat-input-area">
                <div class="flex space-x-2">
                    <input type="text" 
                           placeholder="Ask me anything about your survey..." 
                           class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                           @keydown.enter="sendMessage($event.target.value); $event.target.value = ''">
                    <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Version History Panel (Google Docs Style) -->
    <div x-show="versionPanelOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         @click="versionPanelOpen = false"
         class="fixed inset-0 bg-black bg-opacity-20 z-[999]" 
         style="display: none;">
    </div>
    
    <div class="version-history-panel" :class="{ 'open': versionPanelOpen, 'expanded': showVisualDiff }" @click.stop>
        <!-- Panel Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Version history</h2>
                <p class="text-sm text-gray-500 mt-1">Track all changes to your survey</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Visual Comparison Toggle -->
                <div class="version-comparison-toggle">
                    <input type="checkbox" id="showVisualDiff" x-model="showVisualDiff" class="text-indigo-600 rounded">
                    <label for="showVisualDiff" class="text-gray-700 select-none cursor-pointer">Show changes in preview</label>
                </div>
                <button @click="versionPanelOpen = false" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Version Timeline -->
            <div class="overflow-y-auto p-6 relative" :class="showVisualDiff ? 'w-96 border-r border-gray-200' : 'flex-1'" style="padding-bottom: 200px; overflow-x: visible;">
            <!-- Today Section -->
            <div class="mb-8">
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-4">Today</h3>
                <div class="space-y-6">
                    <!-- Version 3 - Current -->
                    <div class="version-item current">
                        <div class="version-dot"></div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow cursor-pointer"
                             :class="{ 'ring-2 ring-indigo-500': selectedVersion === 3 }"
                             @click="selectedVersion = 3; showDiff = true">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="font-medium">Version 3</span>
                                    <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs">Current</span>
                                </div>
                                <span class="text-sm text-gray-500">2:34 PM</span>
                            </div>
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs">S</div>
                                <span class="text-sm text-gray-700">Sarah Chen</span>
                            </div>
                            <div class="space-y-2">
                                <div class="change-item change-added relative cursor-pointer" 
                                     @mouseenter="hoveredChange = 'demographics'"
                                     @mouseleave="hoveredChange = null">
                                    <span class="font-medium">+ Added:</span> Demographics block with age and location questions
                                    
                                    <!-- Hover Preview -->
                                    <div x-show="hoveredChange === 'demographics'" 
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 transform scale-95"
                                         x-transition:enter-end="opacity-100 transform scale-100"
                                         class="change-preview-tooltip show absolute left-0 top-full mt-1 w-64 z-[100]">
                                        <h4 class="font-medium text-sm mb-2">Preview:</h4>
                                        <div class="change-preview-after">
                                            <div class="text-sm">
                                                <p class="font-medium mb-1">Demographics</p>
                                                <p class="text-gray-600">• Age Range: 18-24, 25-34, 35-44, 45-54, 55+</p>
                                                <p class="text-gray-600">• Location: City, State (text input)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="change-item change-modified relative cursor-pointer"
                                     @mouseenter="hoveredChange = 'title'"
                                     @mouseleave="hoveredChange = null">
                                    <span class="font-medium">~ Modified:</span> Survey title from "Feedback Survey" to "Customer Satisfaction Survey"
                                    
                                    <!-- Hover Preview -->
                                    <div x-show="hoveredChange === 'title'" 
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 transform scale-95"
                                         x-transition:enter-end="opacity-100 transform scale-100"
                                         class="change-preview-tooltip show absolute left-0 top-full mt-1 w-64 z-[100]">
                                        <h4 class="font-medium text-sm mb-2">Title Change:</h4>
                                        <div class="change-preview-before">
                                            <p class="text-sm">Feedback Survey</p>
                                        </div>
                                        <div class="text-center text-gray-400 text-xs my-1">↓</div>
                                        <div class="change-preview-after">
                                            <p class="text-sm">Customer Satisfaction Survey</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Version 2.5 - Auto-save -->
                    <div class="version-item">
                        <div class="version-dot"></div>
                        <div class="bg-gray-50 rounded-lg p-3 text-sm">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-gray-600">Auto-saved</span>
                                <span class="text-gray-500">12:15 PM</span>
                            </div>
                            <p class="text-gray-500">Minor text edits in question 1</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Yesterday Section -->
            <div class="mb-8">
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-4">Yesterday</h3>
                <div class="space-y-6">
                    <!-- Version 2 -->
                    <div class="version-item">
                        <div class="version-dot"></div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow cursor-pointer"
                             :class="{ 'ring-2 ring-indigo-500': selectedVersion === 2 }"
                             @click="selectedVersion = 2; showDiff = true">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">Version 2</span>
                                <span class="text-sm text-gray-500">3:45 PM</span>
                            </div>
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-6 h-6 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs">G</div>
                                <span class="text-sm text-gray-700">You</span>
                            </div>
                            <div class="space-y-2">
                                <div class="change-item change-modified relative cursor-pointer"
                                     @mouseenter="hoveredChange = 'scale'"
                                     @mouseleave="hoveredChange = null">
                                    <span class="font-medium">~ Modified:</span> Rating scale from <span class="diff-removed">3 points</span> to <span class="diff-added">5 points</span>
                                    
                                    <!-- Hover Preview -->
                                    <div x-show="hoveredChange === 'scale'" 
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 transform scale-95"
                                         x-transition:enter-end="opacity-100 transform scale-100"
                                         class="change-preview-tooltip show absolute left-0 top-full mt-1 w-64 z-[100]">
                                        <h4 class="font-medium text-sm mb-2">Scale Options:</h4>
                                        <div class="change-preview-before">
                                            <p class="text-sm">• Satisfied</p>
                                            <p class="text-sm">• Maybe</p>
                                            <p class="text-sm">• Dissatisfied</p>
                                        </div>
                                        <div class="text-center text-gray-400 text-xs my-1">↓</div>
                                        <div class="change-preview-after">
                                            <p class="text-sm">• Very Satisfied</p>
                                            <p class="text-sm">• Satisfied</p>
                                            <p class="text-sm">• Neutral</p>
                                            <p class="text-sm">• Dissatisfied</p>
                                            <p class="text-sm">• Very Dissatisfied</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="change-item change-removed relative cursor-pointer"
                                     @mouseenter="hoveredChange = 'maybe'"
                                     @mouseleave="hoveredChange = null">
                                    <span class="font-medium">- Removed:</span> "Maybe" option from satisfaction question
                                    
                                    <!-- Hover Preview -->
                                    <div x-show="hoveredChange === 'maybe'" 
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 transform scale-95"
                                         x-transition:enter-end="opacity-100 transform scale-100"
                                         class="change-preview-tooltip show absolute left-0 top-full mt-1 w-64 z-[100]">
                                        <h4 class="font-medium text-sm mb-2">Removed Option:</h4>
                                        <div class="change-preview-before">
                                            <p class="text-sm">☐ Maybe</p>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">This ambiguous option was removed for clearer responses</p>
                                    </div>
                                </div>
                                <div class="change-item change-added relative cursor-pointer"
                                     @mouseenter="hoveredChange = 'neutral'"
                                     @mouseleave="hoveredChange = null">
                                    <span class="font-medium">+ Added:</span> "Neutral" and two more granular options
                                    
                                    <!-- Hover Preview -->
                                    <div x-show="hoveredChange === 'neutral'" 
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 transform scale-95"
                                         x-transition:enter-end="opacity-100 transform scale-100"
                                         class="change-preview-tooltip show absolute left-0 top-full mt-1 w-64 z-[100]">
                                        <h4 class="font-medium text-sm mb-2">New Options:</h4>
                                        <div class="change-preview-after">
                                            <p class="text-sm">☑ Very Satisfied <span class="text-xs text-gray-500">(new)</span></p>
                                            <p class="text-sm">☑ Neutral <span class="text-xs text-gray-500">(new)</span></p>
                                            <p class="text-sm">☑ Very Dissatisfied <span class="text-xs text-gray-500">(new)</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center justify-between">
                                <button class="text-sm text-indigo-600 hover:text-indigo-700">View changes</button>
                                <button @click.stop="restoreVersion(2)" class="text-sm text-gray-600 hover:text-gray-900">Restore this version</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Older Versions -->
            <div>
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-4">January 22, 2025</h3>
                <div class="space-y-6">
                    <!-- Version 1 -->
                    <div class="version-item">
                        <div class="version-dot"></div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow cursor-pointer"
                             :class="{ 'ring-2 ring-indigo-500': selectedVersion === 1 }"
                             @click="selectedVersion = 1; showDiff = true">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">Version 1</span>
                                <span class="text-sm text-gray-500">10:23 AM</span>
                            </div>
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-6 h-6 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs">G</div>
                                <span class="text-sm text-gray-700">You</span>
                            </div>
                            <div class="space-y-2">
                                <div class="change-item change-added">
                                    <span class="font-medium">+ Created:</span> Initial survey with 2 questions
                                </div>
                            </div>
                            <div class="mt-3 flex items-center justify-between">
                                <button class="text-sm text-indigo-600 hover:text-indigo-700">View original</button>
                                <button @click.stop="restoreVersion(1)" class="text-sm text-gray-600 hover:text-gray-900">Restore this version</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- Visual Diff Preview -->
            <div x-show="showVisualDiff" x-transition class="flex-1 bg-gray-50 p-6">
                <div x-show="selectedVersion" class="h-full">
                    <!-- Preview Header -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Visual Comparison</h3>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">Added</span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">Modified</span>
                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded">Removed</span>
                        </div>
                    </div>
                    
                    <!-- Split Screen Preview -->
                    <div class="version-preview-container">
                        <!-- Current Version -->
                        <div class="version-preview-pane">
                            <div class="version-preview-header">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Current Version</span>
                                    <span class="text-sm text-gray-500">v3</span>
                                </div>
                            </div>
                            <div class="p-6">
                                <!-- Survey Preview -->
                                <div class="mb-6">
                                    <h1 class="text-2xl font-bold text-gray-900">Customer Satisfaction Survey</h1>
                                    <p class="mt-2 text-gray-600">Help us improve your dining experience by sharing your feedback</p>
                                </div>
                                
                                <!-- Questions with diff indicators -->
                                <div class="space-y-4">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                                        <h3 class="font-medium mb-3">Q1: How satisfied were you with your overall dining experience?</h3>
                                        <div class="space-y-2">
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Very Satisfied</label>
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Satisfied</label>
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Neutral</label>
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Dissatisfied</label>
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Very Dissatisfied</label>
                                        </div>
                                    </div>
                                    
                                    <div class="p-4 bg-white rounded-lg border border-gray-200 diff-highlight-added">
                                        <h3 class="font-medium mb-3">Q2: What could we improve about your experience?</h3>
                                        <textarea class="w-full p-2 border border-gray-200 rounded" placeholder="Type your answer here..."></textarea>
                                    </div>
                                    
                                    <div class="p-4 bg-white rounded-lg border border-gray-200 diff-highlight-added">
                                        <h3 class="font-medium mb-3">Demographics</h3>
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Age Range</label>
                                                <select class="w-full p-2 border border-gray-200 rounded-lg">
                                                    <option>18-24</option>
                                                    <option>25-34</option>
                                                    <option>35-44</option>
                                                    <option>45-54</option>
                                                    <option>55+</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Location</label>
                                                <input type="text" class="w-full p-2 border border-gray-200 rounded-lg" placeholder="City, State">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Version -->
                        <div class="version-preview-pane">
                            <div class="version-preview-header">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Version <span x-text="selectedVersion"></span></span>
                                    <span class="text-sm text-gray-500">Yesterday at 3:45 PM</span>
                                </div>
                            </div>
                            <div class="p-6">
                                <!-- Survey Preview -->
                                <div class="mb-6">
                                    <h1 class="text-2xl font-bold text-gray-900 diff-highlight-modified">Feedback Survey</h1>
                                    <p class="mt-2 text-gray-600">Help us improve your dining experience by sharing your feedback</p>
                                </div>
                                
                                <!-- Questions -->
                                <div class="space-y-4">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200 diff-highlight-modified">
                                        <h3 class="font-medium mb-3">Q1: How satisfied were you with your overall dining experience?</h3>
                                        <div class="space-y-2">
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Very Satisfied</label>
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Satisfied</label>
                                            <label class="flex items-center diff-highlight-removed"><input type="radio" class="mr-2"> Maybe</label>
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Dissatisfied</label>
                                            <label class="flex items-center"><input type="radio" class="mr-2"> Very Dissatisfied</label>
                                        </div>
                                    </div>
                                    
                                    <div class="p-4 bg-white rounded-lg border border-gray-200 diff-highlight-removed">
                                        <h3 class="font-medium mb-3">Q2: What could we improve about your experience?</h3>
                                        <textarea class="w-full p-2 border border-gray-200 rounded" placeholder="Type your answer here..." disabled></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- No Version Selected -->
                <div x-show="!selectedVersion" class="h-full flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-gray-500">Select a version from the timeline to preview changes</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Version Actions -->
        <div class="p-6 border-t border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
                <button class="text-sm text-gray-600 hover:text-gray-900">Download all versions</button>
                <div class="flex items-center space-x-3">
                    <button @click="createNamedVersion()" class="px-4 py-2 text-sm border border-gray-200 rounded-lg hover:bg-white transition-colors">
                        Save as named version
                    </button>
                    <button @click="compareVersions()" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        Compare versions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function surveyEditor() {
            return {
                status: 'draft',
                saveStatus: 'saved',
                activeTab: 'build',
                showSlashMenu: false,
                showAddQuestionDropdown: false,
                settingsSection: 'general',
                versionPanelOpen: false,
                selectedVersion: null,
                showDiff: false,
                showVisualDiff: false,
                hoveredChange: null,
                
                // Comment system data - moved from surveyBuilderData
                activeCommentThread: null,
                commentSidebarActive: false,
                newCommentType: 'suggestion',
                newCommentText: '',
                comments: {
                    'q1': [
                        {
                            id: 'c1',
                            type: 'blocker',
                            text: 'This question may violate GDPR requirements. We need to add a consent statement before collecting any satisfaction data.',
                            author: 'Sarah Chen',
                            role: 'Legal Review',
                            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                            resolved: false
                        },
                        {
                            id: 'c2',
                            type: 'suggestion',
                            text: 'Consider adding a neutral midpoint option. Some cultures prefer to avoid extreme responses.',
                            author: 'David Park',
                            role: 'Research Analyst',
                            timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                            resolved: true
                        }
                    ],
                    'q2': [
                        {
                            id: 'c3',
                            type: 'idea',
                            text: 'We could use AI sentiment analysis on these open-ended responses to identify common themes.',
                            author: 'Emily Rodriguez',
                            role: 'Product Manager',
                            timestamp: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
                            resolved: false
                        }
                    ]
                },
                
                // Questions data - moved from surveyBuilderData so comments can reference it
                questions: [
                    {
                        id: 'q1',
                        questionNumber: 'Q1',
                        type: 'multiple_choice',
                        text: 'How satisfied were you with your overall dining experience?',
                        required: true,
                        options: [
                            { id: 'o1', text: 'Very Satisfied' },
                            { id: 'o2', text: 'Satisfied' },
                            { id: 'o3', text: 'Neutral' },
                            { id: 'o4', text: 'Dissatisfied' },
                            { id: 'o5', text: 'Very Dissatisfied' }
                        ],
                        settings: {
                            allowMultiple: false,
                            randomizeOptions: false,
                            displayFormat: 'list',
                            placeholder: ''
                        },
                        validation: {
                            minSelections: 1,
                            maxSelections: 1,
                            requiredError: 'Please select your satisfaction level',
                            pattern: '',
                            patternError: '',
                            maxLength: null
                        }
                    },
                    {
                        id: 'q2',
                        questionNumber: 'Q2',
                        type: 'text_input',
                        text: 'What could we improve about your experience?',
                        required: false,
                        settings: {
                            inputType: 'textarea',
                            maxLength: 500,
                            placeholder: 'Share your thoughts...',
                            rows: 4
                        },
                        validation: {
                            maxLength: 500,
                            requiredError: 'Please provide your feedback',
                            pattern: '',
                            patternError: ''
                        }
                    },
                    {
                        id: 'q3',
                        questionNumber: 'Q3',
                        type: 'nps',
                        text: 'How likely are you to recommend us to a friend?',
                        required: true,
                        settings: {
                            scaleType: 'numbers',
                            minValue: 0,
                            maxValue: 10,
                            displayFormat: 'list'
                        },
                        validation: {
                            requiredError: 'Please rate your likelihood to recommend'
                        }
                    }
                ],
                
                // Position tooltip within viewport
                positionTooltip(event, tooltipId) {
                    this.$nextTick(() => {
                        const tooltip = document.querySelector(`[x-show="hoveredChange === '${tooltipId}'"]`);
                        if (!tooltip) return;
                        
                        const rect = tooltip.getBoundingClientRect();
                        const panelRect = tooltip.closest('.overflow-y-auto').getBoundingClientRect();
                        
                        // Check if tooltip goes beyond panel bounds
                        if (rect.right > panelRect.right - 20) {
                            tooltip.style.left = 'auto';
                            tooltip.style.right = '0';
                        }
                        
                        // Check if tooltip goes below viewport
                        if (rect.bottom > window.innerHeight - 20) {
                            tooltip.style.top = 'auto';
                            tooltip.style.bottom = '100%';
                            tooltip.style.marginBottom = '4px';
                            tooltip.style.marginTop = '0';
                        }
                    });
                },
                
                updateTitle(text) {
                    this.simulateSave();
                },
                
                updateDescription(text) {
                    this.simulateSave();
                },
                
                simulateSave() {
                    this.saveStatus = 'saving';
                    setTimeout(() => {
                        this.saveStatus = 'saved';
                        setTimeout(() => {
                            this.saveStatus = '';
                        }, 2000);
                    }, 1000);
                },
                
                processAISuggestion(suggestion) {
                    console.log('AI Suggestion:', suggestion);
                    // Simulate AI processing
                    alert('AI would handle: ' + suggestion);
                },
                
                sendMessage(message) {
                    if (!message) return;
                    console.log('Chat message:', message);
                    // Simulate sending message
                    const messagesDiv = document.getElementById('chat-messages');
                    messagesDiv.innerHTML += `
                        <div class="flex justify-end mb-3">
                            <div class="bg-indigo-600 text-white px-4 py-2 rounded-lg max-w-xs">
                                ${message}
                            </div>
                        </div>
                        <div class="flex justify-start mb-3">
                            <div class="bg-gray-200 px-4 py-2 rounded-lg max-w-xs">
                                I'll help you with that! Processing your request...
                            </div>
                        </div>
                    `;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                },
                
                restoreVersion(versionNumber) {
                    if (confirm(`Are you sure you want to restore version ${versionNumber}? This will replace your current survey with the selected version.`)) {
                        console.log('Restoring version', versionNumber);
                        this.simulateSave();
                        // In a real app, this would call the API to restore the version
                        alert(`Version ${versionNumber} has been restored successfully!`);
                        this.versionPanelOpen = false;
                    }
                },
                
                createNamedVersion() {
                    const name = prompt('Enter a name for this version:');
                    if (name) {
                        console.log('Creating named version:', name);
                        this.simulateSave();
                        // In a real app, this would call the API to create a named version
                        alert(`Named version "${name}" has been created!`);
                    }
                },
                
                compareVersions() {
                    console.log('Opening version comparison view');
                    // In a real app, this would open a comparison view
                    alert('Version comparison view would open here, showing side-by-side differences between versions.');
                },
                
                // Comment system methods - moved from surveyBuilderData
                toggleCommentThread(questionId) {
                    this.activeCommentThread = questionId;
                    this.commentSidebarActive = true;
                    // Initialize comments for this question if not exists
                    if (!this.comments[questionId]) {
                        this.comments[questionId] = [];
                    }
                },
                
                closeCommentSidebar() {
                    this.commentSidebarActive = false;
                    // Keep activeCommentThread for a moment to allow transition
                    setTimeout(() => {
                        this.activeCommentThread = null;
                    }, 300);
                },
                
                getComments(questionId) {
                    return this.comments[questionId] || [];
                },
                
                getCommentCount(questionId) {
                    return (this.comments[questionId] || []).length;
                },
                
                hasUnresolvedComments(questionId) {
                    const comments = this.comments[questionId] || [];
                    return comments.some(c => !c.resolved && (c.type === 'blocker' || c.type === 'question'));
                },
                
                addComment(questionId) {
                    if (!this.newCommentText.trim()) return;
                    
                    if (!this.comments[questionId]) {
                        this.comments[questionId] = [];
                    }
                    
                    const comment = {
                        id: 'c' + Date.now(),
                        type: this.newCommentType,
                        text: this.newCommentText,
                        author: 'John Smith',
                        role: 'Research Lead',
                        timestamp: new Date().toISOString(),
                        resolved: false
                    };
                    
                    this.comments[questionId].push(comment);
                    this.newCommentText = '';
                    this.newCommentType = 'suggestion';
                },
                
                resolveComment(questionId, commentId) {
                    const comments = this.comments[questionId];
                    if (comments) {
                        const comment = comments.find(c => c.id === commentId);
                        if (comment) {
                            comment.resolved = true;
                        }
                    }
                },
                
                deleteComment(questionId, commentId) {
                    if (this.comments[questionId]) {
                        this.comments[questionId] = this.comments[questionId].filter(c => c.id !== commentId);
                    }
                },
                
                getCommentTypeLabel(type) {
                    const labels = {
                        blocker: '🔴 Blocker',
                        suggestion: '🟡 Suggestion',
                        question: '🟢 Question',
                        idea: '💡 Idea',
                        approval: '✅ Approval',
                        reference: '📚 Reference'
                    };
                    return labels[type] || type;
                },
                
                formatCommentTime(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if (diffMins < 1) return 'just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
                    return `${Math.floor(diffMins / 1440)}d ago`;
                },
                
                // Question management methods
                selectedQuestion: null,
                showSettings: false,
                showQuestionTypes: null,
                highlightedCategory: null,
                highlightedIndex: 0,
                
                // Inherit from surveyBuilderData  
                init() {
                    // Merge surveyBuilderData properties
                    Object.assign(this, window.surveyBuilderData());
                    
                    // Handle dropdown opening and closing
                    this.$watch('showQuestionTypes', (value) => {
                        if (value) {
                            // Highlight first item
                            const types = this.getAllVisibleTypes();
                            if (types.length > 0) {
                                this.highlightedKey = types[0].key;
                            }
                            
                            // Focus the button for keyboard navigation
                            this.$nextTick(() => {
                                const button = event.target;
                                if (button) button.focus();
                            });
                        } else {
                            // Clear highlight when closing
                            this.highlightedKey = null;
                        }
                    });
                    
                    // Load recently used types from localStorage
                    const saved = localStorage.getItem('recentQuestionTypes');
                    if (saved) {
                        const recentIds = JSON.parse(saved);
                        this.recentlyUsedTypes = recentIds
                            .map(id => {
                                for (const category of Object.values(this.questionTypeCategories)) {
                                    const type = category.find(t => t.id === id);
                                    if (type) return type;
                                }
                                return null;
                            })
                            .filter(Boolean)
                            .slice(0, 3); // Keep only top 3
                    }
                },
                
                addOption(questionId) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (question && question.options) {
                        const newOption = {
                            id: 'o' + Date.now(),
                            text: 'New option'
                        };
                        question.options.push(newOption);
                        this.$nextTick(() => {
                            const newInput = document.querySelector(`[data-option-id="${newOption.id}"]`);
                            if (newInput) {
                                newInput.focus();
                                newInput.select();
                            }
                        });
                    }
                },
                
                removeOption(questionId, optionId) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (question && question.options && question.options.length > 2) {
                        question.options = question.options.filter(o => o.id !== optionId);
                    }
                },
                
                selectQuestion(questionId) {
                    this.selectedQuestion = questionId;
                    this.showSettings = true;
                },
                
                getSelectedQuestion() {
                    return this.questions.find(q => q.id === this.selectedQuestion);
                },
                
                // Ultra-thin dropdown methods
                recentlyUsedTypes: [],
                highlightedKey: null,
                
                getQuestionTypeCategories() {
                    return this.questionTypeCategories;
                },
                
                getAllVisibleTypes() {
                    const types = [];
                    
                    // Add recently used first with section info
                    if (this.recentlyUsedTypes.length > 0) {
                        this.recentlyUsedTypes.forEach(type => {
                            types.push({
                                ...type,
                                section: 'recent',
                                key: 'recent-' + type.id
                            });
                        });
                    }
                    
                    // Add all types from categories with section info
                    for (const [categoryName, category] of Object.entries(this.questionTypeCategories)) {
                        category.forEach(type => {
                            types.push({
                                ...type,
                                section: categoryName,
                                key: categoryName + '-' + type.id
                            });
                        });
                    }
                    
                    return types;
                },
                
                handleDropdownKeydown(event, questionId) {
                    if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                        event.preventDefault();
                        this.navigateDropdown(event.key === 'ArrowDown' ? 'down' : 'up');
                    } else if (event.key === 'Enter' && this.highlightedKey) {
                        event.preventDefault();
                        // Extract the type ID from the highlighted key
                        const types = this.getAllVisibleTypes();
                        const highlightedType = types.find(t => t.key === this.highlightedKey);
                        if (highlightedType) {
                            this.changeQuestionType(questionId, highlightedType.id);
                        }
                    }
                },
                
                navigateDropdown(direction) {
                    const types = this.getAllVisibleTypes();
                    if (types.length === 0) return;
                    
                    const currentIndex = types.findIndex(t => t.key === this.highlightedKey);
                    let newIndex;
                    
                    if (direction === 'down') {
                        newIndex = currentIndex + 1;
                        if (newIndex >= types.length) newIndex = 0;
                    } else {
                        newIndex = currentIndex - 1;
                        if (newIndex < 0) newIndex = types.length - 1;
                    }
                    
                    this.highlightedKey = types[newIndex].key;
                },
                
                isTypeHighlighted(key) {
                    return this.highlightedKey === key;
                },
                
                setHighlightedType(key) {
                    this.highlightedKey = key;
                },
                
                changeQuestionType(questionId, newType) {
                    const question = this.questions.find(q => q.id === questionId);
                    if (question) {
                        // Store old type for potential undo
                        const oldType = question.type;
                        question.type = newType;
                        
                        // Reset type-specific settings
                        this.initializeQuestionSettings(question);
                        
                        // Update recently used types
                        this.updateRecentlyUsedTypes(newType);
                        
                        // Close dropdown
                        this.showQuestionTypes = null;
                        this.highlightedKey = null;
                        
                        // Trigger autosave
                        this.debouncedAutosave();
                    }
                },
                
                updateRecentlyUsedTypes(typeId) {
                    // Find the type object
                    let typeObj = null;
                    for (const category of Object.values(this.questionTypeCategories)) {
                        const type = category.find(t => t.id === typeId);
                        if (type) {
                            typeObj = type;
                            break;
                        }
                    }
                    
                    if (!typeObj) return;
                    
                    // Remove if already exists
                    this.recentlyUsedTypes = this.recentlyUsedTypes.filter(t => t.id !== typeId);
                    
                    // Add to beginning
                    this.recentlyUsedTypes.unshift(typeObj);
                    
                    // Keep only top 3
                    this.recentlyUsedTypes = this.recentlyUsedTypes.slice(0, 3);
                    
                    // Save to localStorage
                    localStorage.setItem('recentQuestionTypes', 
                        JSON.stringify(this.recentlyUsedTypes.map(t => t.id))
                    );
                },
                
                initializeQuestionSettings(question) {
                    // Initialize appropriate settings based on question type
                    switch(question.type) {
                        case 'multiple_choice':
                        case 'dropdown':
                        case 'checkbox':
                        case 'image_choice':
                            if (!question.options) {
                                question.options = [
                                    { id: this.generateId(), text: 'Option 1' },
                                    { id: this.generateId(), text: 'Option 2' },
                                    { id: this.generateId(), text: 'Option 3' }
                                ];
                            }
                            if (!question.settings) {
                                question.settings = {
                                    allowMultiple: question.type === 'checkbox',
                                    randomizeOptions: false,
                                    displayFormat: 'list'
                                };
                            }
                            break;
                            
                        case 'text_input':
                        case 'long_text':
                            if (!question.settings) {
                                question.settings = {
                                    inputType: question.type === 'long_text' ? 'textarea' : 'text',
                                    placeholder: '',
                                    rows: question.type === 'long_text' ? 8 : 4,
                                    maxLength: question.type === 'long_text' ? 1000 : 200
                                };
                            }
                            break;
                            
                        case 'star_rating':
                            if (!question.settings) {
                                question.settings = {
                                    maxStars: 5,
                                    allowHalf: false
                                };
                            }
                            break;
                            
                        case 'number_scale':
                            if (!question.settings) {
                                question.settings = {
                                    minValue: 1,
                                    maxValue: 10,
                                    displayFormat: 'buttons'
                                };
                            }
                            break;
                            
                        case 'nps':
                            if (!question.settings) {
                                question.settings = {
                                    minValue: 0,
                                    maxValue: 10,
                                    minLabel: 'Not likely',
                                    maxLabel: 'Very likely'
                                };
                            }
                            break;
                            
                        case 'likert':
                            if (!question.settings) {
                                question.settings = {
                                    scaleType: 'agreement',
                                    points: 5
                                };
                            }
                            break;
                            
                        case 'slider':
                            if (!question.settings) {
                                question.settings = {
                                    minValue: 0,
                                    maxValue: 100,
                                    step: 1,
                                    showValue: true
                                };
                            }
                            break;
                            
                        case 'emoji_scale':
                            if (!question.settings) {
                                question.settings = {
                                    emojiType: 'satisfaction',
                                    points: 5
                                };
                            }
                            break;
                            
                        case 'matrix':
                            if (!question.rows) {
                                question.rows = [
                                    { id: this.generateId(), text: 'Row 1' },
                                    { id: this.generateId(), text: 'Row 2' }
                                ];
                            }
                            if (!question.columns) {
                                question.columns = [
                                    { id: this.generateId(), text: 'Column 1' },
                                    { id: this.generateId(), text: 'Column 2' },
                                    { id: this.generateId(), text: 'Column 3' }
                                ];
                            }
                            if (!question.settings) {
                                question.settings = {
                                    matrixType: 'radio',
                                    required: false
                                };
                            }
                            break;
                            
                        case 'ranking':
                        case 'card_sort':
                            if (!question.items) {
                                question.items = [
                                    { id: this.generateId(), text: 'Item 1' },
                                    { id: this.generateId(), text: 'Item 2' },
                                    { id: this.generateId(), text: 'Item 3' }
                                ];
                            }
                            if (question.type === 'card_sort' && !question.categories) {
                                question.categories = [
                                    { id: this.generateId(), text: 'Category A' },
                                    { id: this.generateId(), text: 'Category B' }
                                ];
                            }
                            break;
                            
                        case 'constant_sum':
                            if (!question.options) {
                                question.options = [
                                    { id: this.generateId(), text: 'Option 1', value: 0 },
                                    { id: this.generateId(), text: 'Option 2', value: 0 },
                                    { id: this.generateId(), text: 'Option 3', value: 0 }
                                ];
                            }
                            if (!question.settings) {
                                question.settings = {
                                    totalPoints: 100,
                                    forceTotal: true
                                };
                            }
                            break;
                            
                        case 'file_upload':
                            if (!question.settings) {
                                question.settings = {
                                    maxFiles: 5,
                                    maxSize: 10, // MB
                                    allowedTypes: ['pdf', 'doc', 'docx', 'jpg', 'png']
                                };
                            }
                            break;
                            
                        case 'signature':
                            if (!question.settings) {
                                question.settings = {
                                    penColor: '#000000',
                                    penWidth: 2
                                };
                            }
                            break;
                            
                        case 'date':
                        case 'time':
                            if (!question.settings) {
                                question.settings = {
                                    format: question.type === 'date' ? 'MM/DD/YYYY' : 'HH:MM',
                                    minDate: null,
                                    maxDate: null
                                };
                            }
                            break;
                            
                        case 'yes_no':
                            if (!question.settings) {
                                question.settings = {
                                    yesLabel: 'Yes',
                                    noLabel: 'No',
                                    defaultValue: null
                                };
                            }
                            break;
                            
                        // Default settings for any other types
                        default:
                            if (!question.settings) {
                                question.settings = {};
                            }
                            break;
                    }
                    
                    // Ensure validation object exists
                    if (!question.validation) {
                        question.validation = {
                            requiredError: 'This field is required'
                        };
                    }
                },
                
                generateId() {
                    return 'id_' + Math.random().toString(36).substring(2, 11);
                }
            }
        }
    </script>
</body>
</html>